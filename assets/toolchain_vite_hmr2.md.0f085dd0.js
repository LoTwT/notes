import{_ as s,c as n,o as a,a as l}from"./app.a067e1d4.js";const i=JSON.parse('{"title":"\u6BEB\u79D2\u7EA7 HMR \u5B9E\u73B0\u63ED\u79D8","description":"","frontmatter":{},"headers":[{"level":2,"title":"\u521B\u5EFA\u6A21\u5757\u4F9D\u8D56\u56FE","slug":"\u521B\u5EFA\u6A21\u5757\u4F9D\u8D56\u56FE","link":"#\u521B\u5EFA\u6A21\u5757\u4F9D\u8D56\u56FE","children":[{"level":3,"title":"ModuleNode \u521B\u5EFA","slug":"modulenode-\u521B\u5EFA","link":"#modulenode-\u521B\u5EFA","children":[]},{"level":3,"title":"ModuleNode \u7ED1\u5B9A\u4F9D\u8D56\u5173\u7CFB","slug":"modulenode-\u7ED1\u5B9A\u4F9D\u8D56\u5173\u7CFB","link":"#modulenode-\u7ED1\u5B9A\u4F9D\u8D56\u5173\u7CFB","children":[]}]},{"level":2,"title":"\u670D\u52A1\u7AEF\u6536\u96C6\u66F4\u65B0\u6A21\u5757","slug":"\u670D\u52A1\u7AEF\u6536\u96C6\u66F4\u65B0\u6A21\u5757","link":"#\u670D\u52A1\u7AEF\u6536\u96C6\u66F4\u65B0\u6A21\u5757","children":[{"level":3,"title":"\u4FEE\u6539\u6587\u4EF6","slug":"\u4FEE\u6539\u6587\u4EF6","link":"#\u4FEE\u6539\u6587\u4EF6","children":[]},{"level":3,"title":"\u65B0\u589E\u548C\u5220\u9664\u6587\u4EF6","slug":"\u65B0\u589E\u548C\u5220\u9664\u6587\u4EF6","link":"#\u65B0\u589E\u548C\u5220\u9664\u6587\u4EF6","children":[]},{"level":3,"title":"\u5BA2\u6237\u7AEF\u6D3E\u53D1\u66F4\u65B0","slug":"\u5BA2\u6237\u7AEF\u6D3E\u53D1\u66F4\u65B0","link":"#\u5BA2\u6237\u7AEF\u6D3E\u53D1\u66F4\u65B0","children":[]}]}],"relativePath":"toolchain/vite/hmr2.md","lastUpdated":1669599731000}'),p={name:"toolchain/vite/hmr2.md"},o=l(`<h1 id="\u6BEB\u79D2\u7EA7-hmr-\u5B9E\u73B0\u63ED\u79D8" tabindex="-1">\u6BEB\u79D2\u7EA7 HMR \u5B9E\u73B0\u63ED\u79D8 <a class="header-anchor" href="#\u6BEB\u79D2\u7EA7-hmr-\u5B9E\u73B0\u63ED\u79D8" aria-hidden="true">#</a></h1><p>HMR Boundary ( HMR \u8FB9\u754C ) \u7684\u66F4\u65B0\u6A21\u5F0F\u662F\uFF0C\u5F53\u4E00\u4E2A\u6A21\u5757\u53D1\u751F\u6539\u52A8\u65F6\uFF0CVite \u4F1A\u81EA\u52A8\u5BFB\u627E\u66F4\u65B0\u8FB9\u754C\uFF0C\u7136\u540E\u66F4\u65B0\u8FB9\u754C\u6A21\u5757\u3002</p><h2 id="\u521B\u5EFA\u6A21\u5757\u4F9D\u8D56\u56FE" tabindex="-1">\u521B\u5EFA\u6A21\u5757\u4F9D\u8D56\u56FE <a class="header-anchor" href="#\u521B\u5EFA\u6A21\u5757\u4F9D\u8D56\u56FE" aria-hidden="true">#</a></h2><p>\u4E3A\u4E86\u65B9\u4FBF\u7BA1\u7406\u5404\u4E2A\u6A21\u5757\u4E4B\u95F4\u7684\u4F9D\u8D56\u5173\u7CFB\uFF0CVite \u5728 Dev Server \u4E2D\u521B\u5EFA\u4E86\u6A21\u5757\u4F9D\u8D56\u56FE\u7684\u6570\u636E\u7ED3\u6784\uFF0C\u5373 <code>ModuleGraph</code> \u7C7B\uFF0CVite \u4E2D HMR \u8FB9\u754C\u6A21\u5757\u7684\u5224\u5B9A\u4F1A\u4F9D\u9760\u8FD9\u4E2A\u7C7B\u6765\u5B9E\u73B0\u3002</p><p>\u521B\u5EFA\u4F9D\u8D56\u56FE\u6709\u4E09\u6B65\uFF1A</p><ol><li>\u521D\u59CB\u5316\u4F9D\u8D56\u56FE\u5B9E\u4F8B</li><li>\u521B\u5EFA\u4F9D\u8D56\u56FE\u8282\u70B9</li><li>\u7ED1\u5B9A\u5404\u4E2A\u6A21\u5757\u8282\u70B9\u7684\u4F9D\u8D56\u5173\u7CFB</li></ol><p>\u9996\u5148\uFF0CVite \u5728 Dev Server \u542F\u52A8\u65F6\u521D\u59CB\u5316 ModuleGraph \u5B9E\u4F8B\u3002</p><p><code>ModuleNode</code> \u5BF9\u8C61\u4EE3\u8868\u6A21\u5757\u8282\u70B9\u7684\u5177\u4F53\u4FE1\u606F\uFF1A</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ModuleNode</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// \u539F\u59CB\u8BF7\u6C42 url</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">url</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// \u6587\u4EF6\u7EDD\u5BF9\u8DEF\u5F84 + query</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">id</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// \u6587\u4EF6\u7EDD\u5BF9\u8DEF\u5F84</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">file</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">type</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">css</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">info</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ModuleInfo</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// resolveId \u94A9\u5B50\u8FD4\u56DE\u7ED3\u679C\u4E2D\u7684\u5143\u6570\u636E</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">meta</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Record</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// \u8BE5\u6A21\u5757\u7684\u5F15\u7528\u65B9</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">importers</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">Set</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">ModuleNode</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// \u8BE5\u6A21\u5757\u6240\u4F9D\u8D56\u7684\u6A21\u5757</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">importedModules</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">Set</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">ModuleNode</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// \u63A5\u53D7\u66F4\u65B0\u7684\u6A21\u5757</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">acceptedHmrDeps</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">Set</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">ModuleNode</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// \u662F\u5426\u4E3A\`\u63A5\u53D7\u81EA\u8EAB\u6A21\u5757\`\u7684\u66F4\u65B0</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">isSelfAccepting</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// \u7ECF\u8FC7 transform \u94A9\u5B50\u540E\u7684\u7F16\u8BD1\u7ED3\u679C</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">transformResult</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">TransformResult</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// SSR \u8FC7\u7A0B\u4E2D\u7ECF\u8FC7 transform \u94A9\u5B50\u540E\u7684\u7F16\u8BD1\u7ED3\u679C</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">ssrTransformResult</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">TransformResult</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// SSR \u8FC7\u7A0B\u4E2D\u7684\u6A21\u5757\u4FE1\u606F</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">ssrModule</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Record</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// \u4E0A\u4E00\u6B21\u70ED\u66F4\u65B0\u7684\u65F6\u95F4\u6233</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">lastHMRTimestamp</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">constructor</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">url</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">url</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">url</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">type</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">isDirectCSSRequest</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">url</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">css</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">js</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u9700\u8981\u91CD\u70B9\u5173\u6CE8 <code>ModuleNode</code> \u4E2D\u7684 <code>importers</code> \u548C <code>importedModules</code> \uFF0C\u8FD9\u4E24\u6761\u4FE1\u606F\u5206\u522B\u4EE3\u8868\u4E86\u5F53\u524D\u6A21\u5757\u88AB\u54EA\u4E9B\u6A21\u5757\u5F15\u7528\u4EE5\u53CA\u5B83\u4F9D\u8D56\u4E86\u54EA\u4E9B\u6A21\u5757\uFF0C\u662F\u6784\u5EFA\u6574\u4E2A\u6A21\u5757\u4F9D\u8D56\u56FE\u7684\u6839\u57FA\u6240\u5728\u3002</p><h3 id="modulenode-\u521B\u5EFA" tabindex="-1">ModuleNode \u521B\u5EFA <a class="header-anchor" href="#modulenode-\u521B\u5EFA" aria-hidden="true">#</a></h3><p>Vite \u4F1A\u5728 Vite Dev Server \u7684 transform \u4E2D\u95F4\u4EF6\u7684 <code>transformRequest</code> \u4E2D\u4F7F\u7528 <code>ensureEntryFromUrl</code> \u65B9\u6CD5\u521B\u5EFA\u65B0\u7684 <code>ModuleNode</code> \u8282\u70B9\uFF1A</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">async </span><span style="color:#82AAFF;">ensureEntryFromUrl</span><span style="color:#A6ACCD;">(rawUrl: string): </span><span style="color:#FFCB6B;">Promise</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">ModuleNode</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// \u5B9E\u8D28\u662F\u8C03\u7528\u5404\u4E2A\u63D2\u4EF6\u7684 resolveId \u94A9\u5B50\u5F97\u5230\u8DEF\u5F84\u4FE1\u606F</span></span>
<span class="line"><span style="color:#A6ACCD;">  const </span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">url</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">resolvedId</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">meta</span><span style="color:#F07178;">] = await this.resolveUrl(rawUrl)</span></span>
<span class="line"><span style="color:#F07178;">  let mod = this.urlToModuleMap.get(url)</span></span>
<span class="line"><span style="color:#F07178;">  if (!mod) {</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u5982\u679C\u6CA1\u6709\u7F13\u5B58\uFF0C\u5C31\u521B\u5EFA\u65B0\u7684 ModuleNode \u5BF9\u8C61</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u5E76\u8BB0\u5F55\u5230 urlToModuleMap\u3001idToModuleMap\u3001fileToModulesMap \u8FD9\u4E09\u5F20\u8868\u4E2D</span></span>
<span class="line"><span style="color:#F07178;">    mod = new ModuleNode(url)</span></span>
<span class="line"><span style="color:#F07178;">    if (meta) mod.meta = meta</span></span>
<span class="line"><span style="color:#F07178;">    this.urlToModuleMap.set(url, mod)</span></span>
<span class="line"><span style="color:#F07178;">    mod.id = resolvedId</span></span>
<span class="line"><span style="color:#F07178;">    this.idToModuleMap.set(resolvedId, mod)</span></span>
<span class="line"><span style="color:#F07178;">    const file = (mod.file = cleanUrl(resolvedId))</span></span>
<span class="line"><span style="color:#F07178;">    let fileMappedModules = this.fileToModulesMap.get(file)</span></span>
<span class="line"><span style="color:#F07178;">    if (!fileMappedModules) {</span></span>
<span class="line"><span style="color:#F07178;">      fileMappedModules = new Set()</span></span>
<span class="line"><span style="color:#F07178;">      this.fileToModulesMap.set(file, fileMappedModules)</span></span>
<span class="line"><span style="color:#F07178;">    }</span></span>
<span class="line"><span style="color:#F07178;">    fileMappedModules.add(mod)</span></span>
<span class="line"><span style="color:#F07178;">  }</span></span>
<span class="line"><span style="color:#F07178;">  return mod</span></span>
<span class="line"><span style="color:#F07178;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="modulenode-\u7ED1\u5B9A\u4F9D\u8D56\u5173\u7CFB" tabindex="-1">ModuleNode \u7ED1\u5B9A\u4F9D\u8D56\u5173\u7CFB <a class="header-anchor" href="#modulenode-\u7ED1\u5B9A\u4F9D\u8D56\u5173\u7CFB" aria-hidden="true">#</a></h3><p>\u5728 <code>vite:import-analysis</code> \u63D2\u4EF6\u4E2D\uFF0Ctransform \u94A9\u5B50\u4F1A\u5BF9\u6A21\u5757\u4EE3\u7801\u4E2D\u7684 import \u8BED\u53E5\u8FDB\u884C\u5206\u6790\uFF0C\u5F97\u5230\u4EE5\u4E0B\u4FE1\u606F\uFF1A</p><ol><li><code>importedUrls</code> \uFF1A\u5F53\u524D\u6A21\u5757\u7684\u4F9D\u8D56\u6A21\u5757 url \u96C6\u5408</li><li><code>acceptedUrls</code> \uFF1A\u5F53\u524D\u6A21\u5757\u4E2D\u901A\u8FC7 <code>i<wbr>mport.meta.hot.accept</code> \u58F0\u660E\u7684\u4F9D\u8D56\u6A21\u5757 url \u96C6\u5408</li><li><code>isSelfAccepting</code> \uFF1A\u5206\u6790 <code>i<wbr>mport.meta.hot.accept</code> \u7684\u7528\u6CD5\uFF0C\u6807\u8BB0\u662F\u5426\u4E3A<code>\u63A5\u53D7\u81EA\u8EAB\u66F4\u65B0</code>\u7684\u7C7B\u578B</li></ol><p>\u63A5\u4E0B\u6765\uFF0C\u8FDB\u5165\u6838\u5FC3\u7684<code>\u6A21\u5757\u4F9D\u8D56\u5173\u7CFB\u7ED1\u5B9A</code>\u73AF\u8282\uFF1A</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// \u5F15\u7528\u65B9\u6A21\u5757</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> importerModule </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> moduleGraph</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getModuleById</span><span style="color:#A6ACCD;">(importer)</span></span>
<span class="line"><span style="color:#89DDFF;">await</span><span style="color:#A6ACCD;"> moduleGraph</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">updateModuleInfo</span><span style="color:#A6ACCD;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">  importerModule</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  importedUrls</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  normalizedAcceptedUrls</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  isSelfAccepting</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span></code></pre></div><p>\u7ED1\u5B9A\u4F9D\u8D56\u5173\u7CFB\u7684\u903B\u8F91\u4E3B\u8981\u7531 <code>ModuleGraph</code> \u5BF9\u8C61\u7684 <code>updateModuleInfo</code> \u65B9\u6CD5\u5B9E\u73B0\uFF1A</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">async </span><span style="color:#82AAFF;">updateModuleInfo</span><span style="color:#A6ACCD;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">  mod: ModuleNode</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  importedModules: Set</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">string </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> ModuleNode</span><span style="color:#89DDFF;">&gt;,</span></span>
<span class="line"><span style="color:#A6ACCD;">  acceptedModules: Set</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">string </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> ModuleNode</span><span style="color:#89DDFF;">&gt;,</span></span>
<span class="line"><span style="color:#A6ACCD;">  isSelfAccepting: boolean</span></span>
<span class="line"><span style="color:#A6ACCD;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">mod</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">isSelfAccepting</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">isSelfAccepting</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">mod</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">importedModules</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">Set</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// \u7ED1\u5B9A\u8282\u70B9\u4F9D\u8D56\u5173\u7CFB</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">imported</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">of</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">importedModules</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">typeof</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">imported</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">string</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">ensureEntryFromUrl</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">imported</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">imported</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">dep</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">importers</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">mod</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">mod</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">importedModules</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// \u66F4\u65B0 acceptHmrDeps \u4FE1\u606F</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">deps</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">mod</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">acceptedHmrDeps</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">Set</span><span style="color:#F07178;">())</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">accepted</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">of</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">acceptedModules</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">typeof</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">accepted</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">string</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">ensureEntryFromUrl</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">accepted</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">accepted</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">deps</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u81F3\u6B64\uFF0C\u6A21\u5757\u95F4\u7684\u4F9D\u8D56\u5173\u7CFB\u5C31\u6210\u529F\u8FDB\u884C\u7ED1\u5B9A\u4E86\u3002\u968F\u7740\u8D8A\u6765\u8D8A\u591A\u6A21\u5757\u7ECF\u8FC7 <code>vite:import-analysis</code> \u7684 transform \u94A9\u5B50\u5904\u7406\uFF0C\u6240\u6709\u6A21\u5757\u4E4B\u95F4\u7684\u4F9D\u8D56\u5173\u7CFB\u4F1A\u88AB\u8BB0\u5F55\u4E0B\u6765\uFF0C\u6574\u4E2A\u4F9D\u8D56\u56FE\u7684\u4FE1\u606F\u4E5F\u5C31\u88AB\u8865\u5145\u5B8C\u6574\u4E86\u3002</p><h2 id="\u670D\u52A1\u7AEF\u6536\u96C6\u66F4\u65B0\u6A21\u5757" tabindex="-1">\u670D\u52A1\u7AEF\u6536\u96C6\u66F4\u65B0\u6A21\u5757 <a class="header-anchor" href="#\u670D\u52A1\u7AEF\u6536\u96C6\u66F4\u65B0\u6A21\u5757" aria-hidden="true">#</a></h2><p>\u9996\u5148\uFF0CVite \u5728\u670D\u52A1\u542F\u52A8\u65F6\u4F1A\u901A\u8FC7 <code>chokidar</code> \u65B0\u5EFA\u6587\u4EF6\u76D1\u542C\u5668\uFF1A</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// packages/vite/src/node/server/index.ts</span></span>
<span class="line"><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> chokidar </span><span style="color:#89DDFF;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">chokidar</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// \u76D1\u542C\u6839\u76EE\u5F55\u4E0B\u7684\u6587\u4EF6</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> watcher </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> chokidar</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">watch</span><span style="color:#A6ACCD;">(path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resolve</span><span style="color:#A6ACCD;">(root))</span></span>
<span class="line"><span style="color:#676E95;">// \u4FEE\u6539\u6587\u4EF6</span></span>
<span class="line"><span style="color:#A6ACCD;">watcher</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">on</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">change</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">file</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">file</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">normalizePath</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">file</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">moduleGraph</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onFileChange</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">file</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">handleHMRUpdate</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">file</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">server</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#676E95;">// \u65B0\u589E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#A6ACCD;">watcher</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">on</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">add</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">file</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">handleFileAddUnlink</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">normalizePath</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">file</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">server</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#676E95;">// \u5220\u9664\u6587\u4EF6</span></span>
<span class="line"><span style="color:#A6ACCD;">watcher</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">on</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">unlink</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">file</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">handleFileAddUnlink</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">normalizePath</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">file</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">server</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">) </span><span style="color:#676E95;">// packages/vite/src/node/server/index.ts</span></span>
<span class="line"><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> chokidar </span><span style="color:#89DDFF;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">chokidar</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// \u76D1\u542C\u6839\u76EE\u5F55\u4E0B\u7684\u6587\u4EF6</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> watcher </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> chokidar</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">watch</span><span style="color:#A6ACCD;">(path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resolve</span><span style="color:#A6ACCD;">(root))</span></span>
<span class="line"><span style="color:#676E95;">// \u4FEE\u6539\u6587\u4EF6</span></span>
<span class="line"><span style="color:#A6ACCD;">watcher</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">on</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">change</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">file</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">file</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">normalizePath</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">file</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">moduleGraph</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onFileChange</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">file</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">handleHMRUpdate</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">file</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">server</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#676E95;">// \u65B0\u589E\u6587\u4EF6</span></span>
<span class="line"><span style="color:#A6ACCD;">watcher</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">on</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">add</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">file</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">handleFileAddUnlink</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">normalizePath</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">file</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">server</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#676E95;">// \u5220\u9664\u6587\u4EF6</span></span>
<span class="line"><span style="color:#A6ACCD;">watcher</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">on</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">unlink</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">file</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">handleFileAddUnlink</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">normalizePath</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">file</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">server</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span></code></pre></div><h3 id="\u4FEE\u6539\u6587\u4EF6" tabindex="-1">\u4FEE\u6539\u6587\u4EF6 <a class="header-anchor" href="#\u4FEE\u6539\u6587\u4EF6" aria-hidden="true">#</a></h3><p>\u5F53\u4E1A\u52A1\u4EE3\u7801\u4E2D\u67D0\u4E2A\u6587\u4EF6\u88AB\u4FEE\u6539\u65F6\uFF0CVite \u9996\u5148\u4F1A\u8C03\u7528 <code>ModuleGraph</code> \u7684 <code>onFileChange</code> \u5BF9\u6A21\u5757\u56FE\u4E2D\u7684\u5BF9\u5E94\u8282\u70B9\u8FDB\u884C<code>\u6E05\u9664\u7F13\u5B58</code>\u7684\u64CD\u4F5C\u3002</p><p>\u7136\u540E\u6B63\u5F0F\u8FDB\u5165 HMR \u6536\u96C6\u66F4\u65B0\u7684\u9636\u6BB5\uFF0C\u4E3B\u8981\u903B\u8F91\u5728 <code>handleHMRUpdate</code> \u51FD\u6570\u4E2D\u3002</p><p>Vite \u5BF9\u4E8E\u4E0D\u540C\u7C7B\u578B\u7684\u6587\u4EF6\uFF0C\u70ED\u66F4\u65B0\u7B56\u7565\u6709\u6240\u4E0D\u540C\uFF1A</p><ol><li>\u5BF9\u4E8E\u914D\u7F6E\u6587\u4EF6\u548C\u73AF\u5883\u53D8\u91CF\u58F0\u660E\u6587\u4EF6\u7684\u6539\u52A8\uFF0CVite \u4F1A\u76F4\u63A5\u91CD\u542F\u670D\u52A1\u5668</li><li>\u5BF9\u4E8E\u5BA2\u6237\u7AEF\u6CE8\u5165\u7684\u6587\u4EF6 ( vite / dist / client / client.mjs ) \u7684\u6539\u52A8\uFF0CVite \u4F1A\u7ED9\u5BA2\u6237\u7AEF\u53D1\u9001 <code>full-reload</code> \u4FE1\u606F\uFF0C\u8BA9\u5BA2\u6237\u7AEF\u5237\u65B0\u9875\u9762</li><li>\u5BF9\u4E8E\u666E\u901A\u6587\u4EF6\u7684\u6539\u52A8\uFF0CVite \u9996\u5148\u4F1A\u83B7\u53D6\u9700\u8981\u70ED\u66F4\u65B0\u7684\u6A21\u5757\uFF0C\u7136\u540E\u5BF9\u8FD9\u4E9B\u6A21\u5757\u4E00\u6B21\u67E5\u627E\u70ED\u66F4\u65B0\u8FB9\u754C\uFF0C\u7136\u540E\u5C06\u6A21\u5757\u66F4\u65B0\u7684\u4FE1\u606F\u4F20\u7ED9\u5BA2\u6237\u7AEF</li></ol><p>\u5176\u4E2D\uFF0C\u5BF9\u4E8E\u666E\u901A\u6587\u4EF6\u7684\u70ED\u66F4\u65B0\u8FB9\u754C\u67E5\u627E\u7684\u903B\u8F91\uFF0C\u4E3B\u8981\u96C6\u4E2D\u5728 <code>upadteModules</code> \u51FD\u6570\u4E2D\u3002</p><p>\u5F53\u70ED\u66F4\u65B0\u8FB9\u754C\u7684\u4FE1\u606F\u6536\u96C6\u5B8C\u6210\u540E\uFF0C\u670D\u52A1\u7AEF\u4F1A\u5C06\u8FD9\u4E9B\u4FE1\u606F\u63A8\u9001\u7ED9\u5BA2\u6237\u7AEF\uFF0C\u4ECE\u800C\u5B8C\u6210\u5C40\u90E8\u7684\u6A21\u5757\u66F4\u65B0\u3002</p><h3 id="\u65B0\u589E\u548C\u5220\u9664\u6587\u4EF6" tabindex="-1">\u65B0\u589E\u548C\u5220\u9664\u6587\u4EF6 <a class="header-anchor" href="#\u65B0\u589E\u548C\u5220\u9664\u6587\u4EF6" aria-hidden="true">#</a></h3><p>\u5BF9\u4E8E\u65B0\u589E\u548C\u5220\u9664\u6587\u4EF6\uFF0CVite \u4E5F\u901A\u8FC7 <code>chokidar</code> \u76D1\u542C\u4E86\u76F8\u5E94\u4E8B\u4EF6\uFF1A</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">watcher</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">on</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">add</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">file</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">handleFileAddUnlink</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">normalizePath</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">file</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">server</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">watcher</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">on</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">unlink</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">file</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">handleFileAddUnlink</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">normalizePath</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">file</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">server</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span></code></pre></div><p><code>handleFileAddUnlink</code> \u540C\u6837\u8C03\u7528 <code>upadteModules</code> \u5B8C\u6210\u6A21\u5757\u70ED\u66F4\u65B0\u8FB9\u754C\u7684\u67E5\u627E\u548C\u66F4\u65B0\u4FE1\u606F\u7684\u63A8\u9001\u3002</p><h3 id="\u5BA2\u6237\u7AEF\u6D3E\u53D1\u66F4\u65B0" tabindex="-1">\u5BA2\u6237\u7AEF\u6D3E\u53D1\u66F4\u65B0 <a class="header-anchor" href="#\u5BA2\u6237\u7AEF\u6D3E\u53D1\u66F4\u65B0" aria-hidden="true">#</a></h3><p>\u670D\u52A1\u7AEF\u4F1A\u76D1\u542C\u6587\u4EF6\u7684\u6539\u52A8\uFF0C\u7136\u540E\u8BA1\u7B97\u51FA\u5BF9\u5E94\u7684\u70ED\u66F4\u65B0\u4FE1\u606F\uFF0C\u901A\u8FC7 WebSocket \u5C06\u66F4\u65B0\u4FE1\u606F\u4F20\u9012\u7ED9\u5BA2\u6237\u7AEF\uFF0C\u5177\u4F53\u6765\u8BF4\uFF0C\u4F1A\u7ED9\u5BA2\u6237\u7AEF\u53D1\u9001\u5982\u4E0B\u7684\u6570\u636E\uFF1A</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki"><code><span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  type</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">update</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  update</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#676E95;">// \u66F4\u65B0\u7C7B\u578B\uFF0C\u4E5F\u53EF\u80FD\u662F \`css-update\`</span></span>
<span class="line"><span style="color:#A6ACCD;">      type</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">js-update</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#676E95;">// \u66F4\u65B0\u65F6\u95F4\u6233</span></span>
<span class="line"><span style="color:#A6ACCD;">      timestamp</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1650702020986</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#676E95;">// \u70ED\u66F4\u6A21\u5757\u8DEF\u5F84</span></span>
<span class="line"><span style="color:#A6ACCD;">      path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/src/main.ts</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#676E95;">// \u63A5\u53D7\u7684\u5B50\u6A21\u5757\u8DEF\u5F84</span></span>
<span class="line"><span style="color:#A6ACCD;">      acceptedPath</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/src/render.ts</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#676E95;">// \u6216\u8005 full-reload \u4FE1\u53F7</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  type</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">full-reload</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u90A3\u4E48\u5BA2\u6237\u7AEF\u662F\u5982\u4F55\u63A5\u53D7\u8FD9\u4E9B\u4FE1\u606F\u5E76\u8FDB\u884C\u6A21\u5757\u66F4\u65B0\u7684\u5462\uFF1F</p><p>Vite \u5728\u5F00\u53D1\u9636\u6BB5\u4F1A\u9ED8\u8BA4\u5728 HTML \u4E2D\u6CE8\u5165\u4E00\u6BB5\u5BA2\u6237\u7AEF\u7684\u811A\u672C\uFF0C\u5373\uFF1A</p><div class="language-html"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki"><code><span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">type</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">module</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">src</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/@vite/client</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><p>\u5728\u8FD9\u4E2A\u811A\u672C\u4E2D\uFF0C\u521B\u5EFA\u4E86 WebSocket \u5BA2\u6237\u7AEF\uFF0C\u5E76\u4E0E Vite Dev Server \u4E2D\u7684 WebSocket \u670D\u52A1\u7AEF\u5EFA\u7ACB\u53CC\u5411\u8FDE\u63A5\uFF1A</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> socketProtocol </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> (location</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">protocol </span><span style="color:#89DDFF;">===</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">https:</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">wss</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ws</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> socketHost </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`\${</span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> location</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">hostname</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">:</span><span style="color:#89DDFF;">\${&quot;</span><span style="color:#C3E88D;">3000</span><span style="color:#89DDFF;">&quot;}\`</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> socket </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">WebSocket</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">\`\${</span><span style="color:#A6ACCD;">socketProtocol</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">://</span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">socketHost</span><span style="color:#89DDFF;">}\`</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">vite-hmr</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span></code></pre></div><p>\u968F\u540E\u4F1A\u76D1\u542C socket \u5B9E\u4F8B\u7684 message \u4E8B\u4EF6\uFF0C\u63A5\u6536\u5230\u670D\u52A1\u7AEF\u4F20\u6765\u7684\u66F4\u65B0\u4FE1\u606F\uFF1A</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">socket</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addEventListener</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">message</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">({</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">data</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">})</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">handleMessage</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">JSON</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">parse</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">data</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span></code></pre></div><p><code>handleMessage</code> \u51FD\u6570\uFF1A</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">handleMessage</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">payload</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">HMRPayload</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">switch</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">payload</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">type</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">case</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">connected</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">[vite] connected.</span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;">// \u5FC3\u8DF3\u68C0\u6D4B</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">setInterval</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">socket</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">send</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ping</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">__HMR_TIMEOUT__</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">break</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">case</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">update</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">payload</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">updates</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">forEach</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">update</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">update</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">type</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">js-update</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#82AAFF;">queueUpdate</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">fetchUpdate</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">update</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;">// css-update</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;">// \u7701\u7565\u5B9E\u73B0</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">[vite] css hot updated: </span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">path</span><span style="color:#89DDFF;">}\`</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">break</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">case</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">full-reload</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;">// \u5237\u65B0\u9875\u9762</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">location</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">reload</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u7701\u7565\u5176\u5B83\u6D88\u606F\u7C7B\u578B</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5176\u4E2D\uFF0C\u91CD\u70B9\u5173\u6CE8 JS \u7684\u66F4\u65B0\u903B\u8F91\uFF1A</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#82AAFF;">queueUpdate</span><span style="color:#A6ACCD;">(</span><span style="color:#82AAFF;">fetchUpdate</span><span style="color:#A6ACCD;">(update))</span></span>
<span class="line"></span></code></pre></div><p><code>queueUpdate</code> \u548C <code>fetchUpdate</code> \u7684\u5B9E\u73B0\uFF1A</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> pending </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> queued</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Promise</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">void</span><span style="color:#A6ACCD;">) </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">undefined</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">[] </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// \u6279\u91CF\u4EFB\u52A1\u5904\u7406\uFF0C\u4E0D\u4E0E\u5177\u4F53\u7684\u70ED\u66F4\u65B0\u884C\u4E3A\u6302\u94A9\uFF0C\u4E3B\u8981\u8D77\u4EFB\u52A1\u8C03\u5EA6\u4F5C\u7528</span></span>
<span class="line"><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">queueUpdate</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Promise</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">void</span><span style="color:#A6ACCD;">) </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">undefined</span><span style="color:#89DDFF;">&gt;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">queued</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">push</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">p</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">pending</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">pending</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">Promise</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resolve</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">pending</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">loading</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> [</span><span style="color:#89DDFF;">...</span><span style="color:#A6ACCD;">queued</span><span style="color:#F07178;">]</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">queued</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> []</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">;</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">Promise</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">all</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">loading</span><span style="color:#F07178;">))</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">forEach</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">fn</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fn</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">fn</span><span style="color:#F07178;">())</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// \u6D3E\u53D1\u70ED\u66F4\u65B0\u7684\u4E3B\u8981\u903B\u8F91</span></span>
<span class="line"><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">fetchUpdate</span><span style="color:#89DDFF;">({</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">path</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">acceptedPath</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">timestamp</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Update</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// \u540E\u6587\u4F1A\u4ECB\u7ECD hotModuleMap \u7684\u4F5C\u7528\uFF0C\u4F60\u6682\u4E14\u4E0D\u7528\u7EA0\u7ED3\u5B9E\u73B0\uFF0C\u53EF\u4EE5\u7406\u89E3\u4E3A HMR \u8FB9\u754C\u6A21\u5757\u76F8\u5173\u7684\u4FE1\u606F</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mod</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">hotModulesMap</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">path</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">moduleMap</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">Map</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">isSelfUpdate</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">path</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">acceptedPath</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 1. \u6574\u7406\u9700\u8981\u66F4\u65B0\u7684\u6A21\u5757\u96C6\u5408</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">modulesToUpdate</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">Set</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">isSelfUpdate</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u63A5\u53D7\u81EA\u8EAB\u66F4\u65B0</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">modulesToUpdate</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">path</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u63A5\u53D7\u5B50\u6A21\u5757\u66F4\u65B0</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">deps</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">of</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mod</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">callbacks</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">deps</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">forEach</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">dep</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">acceptedPath</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">modulesToUpdate</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 2. \u6574\u7406\u9700\u8981\u6267\u884C\u7684\u66F4\u65B0\u56DE\u8C03\u51FD\u6570</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// \u6CE8\uFF1A mod.callbacks \u4E3A i<wbr>mport.meta.hot.accept \u4E2D\u7ED1\u5B9A\u7684\u66F4\u65B0\u56DE\u8C03\u51FD\u6570\uFF0C\u540E\u6587\u4F1A\u4ECB\u7ECD</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">qualifiedCallbacks</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mod</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">callbacks</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">filter</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">({</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">deps</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">})</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">deps</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">some</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">dep</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">modulesToUpdate</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">has</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 3. \u5BF9\u5C06\u8981\u66F4\u65B0\u7684\u6A21\u5757\u8FDB\u884C\u5931\u6D3B\u64CD\u4F5C\uFF0C\u5E76\u901A\u8FC7\u52A8\u6001 import \u62C9\u53D6\u6700\u65B0\u7684\u6A21\u5757\u4FE1\u606F</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">Promise</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">all</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">Array</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">from</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">modulesToUpdate</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">map</span><span style="color:#F07178;">(</span><span style="color:#C792EA;">async</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">dep</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">disposer</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">disposeMap</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">disposer</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">disposer</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">dataMap</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">path</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">query</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">dep</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">split</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">?</span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">try</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newMod</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">import</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#676E95;">/* @vite-ignore */</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">base</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">slice</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">1</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">+</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">?import&amp;t=</span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">timestamp</span><span style="color:#89DDFF;">}\${</span><span style="color:#A6ACCD;">query </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">&amp;</span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">query</span><span style="color:#89DDFF;">}\`</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;&quot;}\`</span></span>
<span class="line"><span style="color:#F07178;">        )</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">moduleMap</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">set</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">dep</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newMod</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">e</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">warnFailedFetch</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  )</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 4. \u8FD4\u56DE\u4E00\u4E2A\u51FD\u6570\uFF0C\u7528\u6765\u6267\u884C\u6240\u6709\u7684\u66F4\u65B0\u56DE\u8C03</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">deps</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fn</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">of</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">qualifiedCallbacks</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">fn</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">deps</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">map</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">dep</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">moduleMap</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;">)))</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">loggedPath</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">isSelfUpdate</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">path</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">\`\${</span><span style="color:#A6ACCD;">acceptedPath</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;"> via </span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">path</span><span style="color:#89DDFF;">}\`</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">[vite] hot updated: </span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">loggedPath</span><span style="color:#89DDFF;">}\`</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5BF9\u70ED\u66F4\u65B0\u7684\u8FB9\u754C\u6A21\u5757\u6765\u8BF4\uFF0C\u9700\u8981\u5728\u5BA2\u6237\u7AEF\u83B7\u53D6\u8FD9\u4E9B\u4FE1\u606F\uFF1A</p><ul><li>\u8FB9\u754C\u6A21\u5757\u6240\u63A5\u53D7 ( accept ) \u7684\u6A21\u5757</li><li>accept \u7684\u6A21\u5757\u89E6\u53D1\u66F4\u65B0\u540E\u7684\u56DE\u8C03</li></ul><p>\u5728 <code>vite:import-analysis</code> \u63D2\u4EF6\u4E2D\uFF0C\u4F1A\u7ED9\u5305\u542B\u70ED\u66F4\u65B0\u903B\u8F91\u7684\u6A21\u5757\u6CE8\u5165\u4E00\u4E9B\u5DE5\u5177\u4EE3\u7801\uFF0C<code>createHotContext</code> \u5C31\u662F\u5BA2\u6237\u7AEF\u811A\u672C\u4E2D\u7684\u4E00\u4E2A\u5DE5\u5177\u51FD\u6570\uFF1A</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> hotModulesMap </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Map</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">HotModule</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> createHotContext </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ownerPath</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// \u5C06\u5F53\u524D\u6A21\u5757\u7684\u63A5\u6536\u6A21\u5757\u4FE1\u606F\u548C\u66F4\u65B0\u56DE\u8C03\u6CE8\u518C\u5230 hotModulesMap</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">function</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">acceptDeps</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">deps</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#F07178;">[]</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">callback</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">HotCallback</span><span style="color:#F07178;">[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">fn</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{})</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mod</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">HotModule</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">hotModulesMap</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">ownerPath</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      id</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ownerPath</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      callbacks</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> []</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">mod</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">callbacks</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">push</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">deps</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      fn</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">callback</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">hotModulesMap</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">set</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">ownerPath</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mod</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// i<wbr>mport.meta.hot.accept</span></span>
<span class="line"><span style="color:#F07178;">    accept</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">deps</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">callback</span><span style="color:#89DDFF;">?:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">deps</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">function</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">deps</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">acceptDeps</span><span style="color:#F07178;">([</span><span style="color:#A6ACCD;">ownerPath</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">([</span><span style="color:#A6ACCD;">mod</span><span style="color:#89DDFF;">])</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">deps</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">deps</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">mod</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">deps</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">string</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">acceptDeps</span><span style="color:#F07178;">([</span><span style="color:#A6ACCD;">deps</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">([</span><span style="color:#A6ACCD;">mod</span><span style="color:#89DDFF;">])</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">callback</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">callback</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">mod</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">Array</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isArray</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">deps</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">acceptDeps</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">deps</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">callback</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">throw</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">Error</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">invalid hot.accept() usage.</span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// i<wbr>mport.meta.hot.dispose</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// i<wbr>mport.meta.hot.invalidate</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// \u7701\u7565\u66F4\u591A\u65B9\u6CD5\u7684\u5B9E\u73B0</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>\u56E0\u6B64\uFF0CVite \u7ED9\u6BCF\u4E2A\u70ED\u66F4\u65B0\u8FB9\u754C\u6A21\u5757\u6CE8\u5165\u7684\u5DE5\u5177\u4EE3\u7801\u4E3B\u8981\u6709\u4E24\u4E2A\u4F5C\u7528\uFF1A</p><ul><li>\u6CE8\u5165 <code>i<wbr>mport.meta.hot</code> \u5BF9\u8C61\u7684\u5B9E\u73B0</li><li>\u5C06\u5F53\u524D\u6A21\u5757 accept \u8FC7\u7684\u6A21\u5757\u548C\u66F4\u65B0\u56DE\u8C03\u51FD\u6570\u8BB0\u5F55\u5230 hotModulesMap \u8868\u4E2D</li></ul><p>\u800C\u524D\u9762\u6240\u8BF4\u7684 <code>fetchUpdate</code> \u51FD\u6570\u5219\u662F\u901A\u8FC7 <code>hotModuleMap</code> \u6765\u83B7\u53D6\u8FB9\u754C\u6A21\u5757\u7684\u76F8\u5173\u4FE1\u606F\uFF0C\u5728 accept \u7684\u6A21\u5757\u53D1\u751F\u53D8\u52A8\u540E\uFF0C\u901A\u8FC7\u52A8\u6001 import \u62C9\u53D6\u6700\u65B0\u7684\u6A21\u5757\u5185\u5BB9\uFF0C\u7136\u540E\u8FD4\u56DE\u66F4\u65B0\u56DE\u8C03\uFF0C\u8BA9 <code>queueUpdate</code> \u8FD9\u4E2A\u8C03\u5EA6\u51FD\u6570\u6267\u884C\u66F4\u65B0\u56DE\u8C03\uFF0C\u4ECE\u800C\u5B8C\u6210\u6D3E\u53D1\u66F4\u65B0\u7684\u8FC7\u7A0B\u3002</p><p>\u81F3\u6B64\uFF0CHMR \u7684\u8FC7\u7A0B\u5C31\u7ED3\u675F\u4E86\u3002</p>`,59),e=[o];function c(t,r,F,y,D,A){return a(),n("div",null,e)}const d=s(p,[["render",c]]);export{i as __pageData,d as default};
