<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>依赖预构建 | Ayingotts's notes</title>
    <meta name="description" content="useless and naive notes">
    <link rel="stylesheet" href="/assets/style.408b4477.css">
    <link rel="modulepreload" href="/assets/app.a067e1d4.js">
    <link rel="modulepreload" href="/assets/toolchain_vite_prebuild.md.0f2e5904.lean.js">
    
    <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-c92dac7e><!--[--><!--]--><!--[--><span tabindex="-1" data-v-db27ec01></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-db27ec01> Skip to content </a><!--]--><!----><header class="VPNav" data-v-c92dac7e data-v-f621f495><div class="VPNavBar has-sidebar" data-v-f621f495 data-v-9c650fd0><div class="container" data-v-9c650fd0><div class="VPNavBarTitle has-sidebar" data-v-9c650fd0 data-v-ebccea6a><a class="title" href="/" data-v-ebccea6a><!--[--><!--]--><!--[--><img class="VPImage logo" src="/mea.jpg" alt data-v-4a040b55><!--]--><!--[-->Ayingotts&#39;s notes<!--]--><!--[--><!--]--></a></div><div class="content" data-v-9c650fd0><!--[--><!--]--><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-9c650fd0 data-v-2bb0b325><span id="main-nav-aria-label" class="visually-hidden" data-v-2bb0b325>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/base/bitwiseOperation.html" data-v-2bb0b325 data-v-5a374801 data-v-7ba7224b><!--[-->计算机基础<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/compilation/intro.html" data-v-2bb0b325 data-v-5a374801 data-v-7ba7224b><!--[-->编译<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/algorithm/index.html" data-v-2bb0b325 data-v-5a374801 data-v-7ba7224b><!--[-->算法<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/http/message/1-message.html" data-v-2bb0b325 data-v-5a374801 data-v-7ba7224b><!--[-->HTTP<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/devops/aws-ubuntu.html" data-v-2bb0b325 data-v-5a374801 data-v-7ba7224b><!--[-->DevOps<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/typescript/fun/basic.html" data-v-2bb0b325 data-v-5a374801 data-v-7ba7224b><!--[-->TypeScript<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/toolchain/index.html" data-v-2bb0b325 data-v-5a374801 data-v-7ba7224b><!--[-->工具链<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/others/cmd.html" data-v-2bb0b325 data-v-5a374801 data-v-7ba7224b><!--[-->其他<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-9c650fd0 data-v-fe0bb805><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-fe0bb805 data-v-7cf364fc data-v-dc3b1b1e><span class="check" data-v-dc3b1b1e><span class="icon" data-v-dc3b1b1e><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-7cf364fc><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-7cf364fc><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-9c650fd0 data-v-fee08697 data-v-620d60cf><!--[--><a class="VPSocialLink" href="https://github.com/lotwt/notes" target="_blank" rel="noopener" data-v-620d60cf data-v-7dad4ed6><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-9c650fd0 data-v-9ff62427 data-v-66d5c524><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-66d5c524><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-66d5c524><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-66d5c524><div class="VPMenu" data-v-66d5c524 data-v-56fa3a4a><!----><!--[--><!--[--><!----><div class="group" data-v-9ff62427><div class="item appearance" data-v-9ff62427><p class="label" data-v-9ff62427>Appearance</p><div class="appearance-action" data-v-9ff62427><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-9ff62427 data-v-7cf364fc data-v-dc3b1b1e><span class="check" data-v-dc3b1b1e><span class="icon" data-v-dc3b1b1e><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-7cf364fc><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-7cf364fc><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-9ff62427><div class="item social-links" data-v-9ff62427><div class="VPSocialLinks social-links-list" data-v-9ff62427 data-v-620d60cf><!--[--><a class="VPSocialLink" href="https://github.com/lotwt/notes" target="_blank" rel="noopener" data-v-620d60cf data-v-7dad4ed6><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-9c650fd0 data-v-b5b99466><span class="container" data-v-b5b99466><span class="top" data-v-b5b99466></span><span class="middle" data-v-b5b99466></span><span class="bottom" data-v-b5b99466></span></span></button></div></div></div><!----></header><div class="VPLocalNav" data-v-c92dac7e data-v-cfe445aa><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-cfe445aa><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-cfe445aa><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-cfe445aa>Menu</span></button><a class="top-link" href="#" data-v-cfe445aa> Return to top </a></div><aside class="VPSidebar" data-v-c92dac7e data-v-c857a5d6><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-c857a5d6><span class="visually-hidden" id="sidebar-aria-label" data-v-c857a5d6> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-c857a5d6><section class="VPSidebarGroup" data-v-c857a5d6 data-v-87ede61d><!----><div class="items" data-v-87ede61d><!--[--><!--[--><a class="VPLink link link" href="/toolchain/index.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>目录</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><div class="group" data-v-c857a5d6><section class="VPSidebarGroup collapsible" data-v-c857a5d6 data-v-87ede61d><div class="title" role="button" data-v-87ede61d><h2 class="title-text" data-v-87ede61d>Vite</h2><div class="action" data-v-87ede61d><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-87ede61d><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-87ede61d><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-87ede61d><!--[--><!--[--><a class="VPLink link link" href="/toolchain/vite/overview.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>概览</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/module.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>模块规范</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/style.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>样式方案</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/esbuild.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>esbuild</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/plugin.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>插件</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/hmr.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>热更新</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/polyfill.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>语法降级与 polyfill</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/ssr.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>SSR</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/federation.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>模块联邦</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/esm.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>再谈 ESM</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/optimize.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>性能优化</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/config.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>配置解析</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link active" href="/toolchain/vite/prebuild.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>依赖预构建</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/pluginPipeline.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>插件流水线</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/hmr2.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>毫秒级 HMR 实现揭秘</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><div class="group" data-v-c857a5d6><section class="VPSidebarGroup collapsible" data-v-c857a5d6 data-v-87ede61d><div class="title" role="button" data-v-87ede61d><h2 class="title-text" data-v-87ede61d>工程化</h2><div class="action" data-v-87ede61d><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-87ede61d><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-87ede61d><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-87ede61d><!--[--><!--[--><a class="VPLink link link" href="/toolchain/engineering/engineering.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>前端工程化</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/engineering/standard.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>规范</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/engineering/services.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>服务</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/engineering/management.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>管理</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/engineering/build.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>构建</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/engineering/structure.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>组织</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/engineering/deploy.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>部署</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/engineering/docsite.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>文档站点</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/engineering/devops.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>开发运维</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><div class="group" data-v-c857a5d6><section class="VPSidebarGroup collapsible" data-v-c857a5d6 data-v-87ede61d><div class="title" role="button" data-v-87ede61d><h2 class="title-text" data-v-87ede61d>Rollup</h2><div class="action" data-v-87ede61d><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-87ede61d><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-87ede61d><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-87ede61d><!--[--><!--[--><a class="VPLink link link" href="/toolchain/rollup/tspackage.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>构建 ts package</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><div class="group" data-v-c857a5d6><section class="VPSidebarGroup collapsible" data-v-c857a5d6 data-v-87ede61d><div class="title" role="button" data-v-87ede61d><h2 class="title-text" data-v-87ede61d>Babel</h2><div class="action" data-v-87ede61d><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-87ede61d><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-87ede61d><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-87ede61d><!--[--><!--[--><a class="VPLink link link" href="/toolchain/babel/babel.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>Babel</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/babel/AST.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>AST</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/babel/API.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>API</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/babel/parser.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>Parser</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/babel/traverse.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>Traverse</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-c92dac7e data-v-f75f4939><div class="VPDoc has-sidebar has-aside" data-v-f75f4939 data-v-7dd55a9c><div class="container" data-v-7dd55a9c><div class="aside" data-v-7dd55a9c><div class="aside-curtain" data-v-7dd55a9c></div><div class="aside-container" data-v-7dd55a9c><div class="aside-content" data-v-7dd55a9c><div class="VPDocAside" data-v-7dd55a9c data-v-5ba92c36><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-5ba92c36 data-v-effbad20><div class="content" data-v-effbad20><div class="outline-marker" data-v-effbad20></div><div class="outline-title" data-v-effbad20>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-effbad20><span class="visually-hidden" id="doc-outline-aria-label" data-v-effbad20> Table of Contents for current page </span><ul class="root" data-v-effbad20 data-v-d5e839a5><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-5ba92c36></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-7dd55a9c><div class="content-container" data-v-7dd55a9c><!--[--><!--]--><main class="main" data-v-7dd55a9c><div style="position:relative;" class="vp-doc _toolchain_vite_prebuild" data-v-7dd55a9c><div><h1 id="依赖预构建" tabindex="-1">依赖预构建 <a class="header-anchor" href="#依赖预构建" aria-hidden="true">#</a></h1><p>Vite 依赖预构建的底层实现中，大量使用了 Esbuild ，实现了比较复杂的 Esbuild 插件，同时也应用了诸多 Esbuild 使用技巧。</p><h2 id="核心流程" tabindex="-1">核心流程 <a class="header-anchor" href="#核心流程" aria-hidden="true">#</a></h2><p>关于预构建的所有实现代码都在 <code>optimizeDeps</code> 函数中，这个函数在 <code>packages/vite/src/node/optimizer/index.ts</code> 中。</p><h3 id="缓存判断" tabindex="-1">缓存判断 <a class="header-anchor" href="#缓存判断" aria-hidden="true">#</a></h3><p>首先是预构建缓存的判断。</p><p>Vite 在每次预构建之后，都将一些关键信息写入到了 <code>_metadata.json</code> 文件中，第二次启动项目时，会通过这个文件中的 hash 值来进行缓存的判断，如果命中缓存则不会进行后续的与构建流程，代码如下：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// _metadata.json 文件所在的路径</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> dataPath </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#A6ACCD;">(cacheDir</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">_metadata.json</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#676E95;">// 根据当前的配置计算出哈希值</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> mainHash </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getDepHash</span><span style="color:#A6ACCD;">(root</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> config)</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">DepOptimizationMetadata</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">hash</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> mainHash</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">browserHash</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> mainHash</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">optimized</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{},</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#676E95;">// 默认走到里面的逻辑</span></span>
<span class="line"><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">force) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">prevData</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">DepOptimizationMetadata</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">undefined</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">try</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// 读取元数据</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">prevData</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">JSON</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">parse</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">fs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readFileSync</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">dataPath</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">utf-8</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">e</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 当前计算出的哈希值与 _metadata.json 中记录的哈希值一致，表示命中缓存，不用预构建</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">prevData</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">prevData</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">hash</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">hash</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hash is consistent. Skipping. Use --force to override.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">prevData</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>哈希计算的策略，决定哪些配置和文件有可能影响预构建的结果，根据这些信息来生成哈希值。这部分逻辑集中在 <code>getDepHash</code> 函数中，如下：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> lockfileFormats </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> [</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">package-lock.json</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">yarn.lock</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">pnpm-lock.yaml</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">]</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getDepHash</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">root</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ResolvedConfig</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 获取 lock 文件内容</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">content</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">lookupFile</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">root</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">lockfileFormats</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 除了 lock 文件外，还需要考虑下面的一些配置信息</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">content</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">JSON</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">stringify</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;">// 开发/生产环境</span></span>
<span class="line"><span style="color:#F07178;">      mode</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">mode</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;">// 项目根路径</span></span>
<span class="line"><span style="color:#F07178;">      root</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">root</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;">// 路径解析配置</span></span>
<span class="line"><span style="color:#F07178;">      resolve</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">resolve</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;">// 自定义资源类型</span></span>
<span class="line"><span style="color:#F07178;">      assetsInclude</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">assetsInclude</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;">// 插件</span></span>
<span class="line"><span style="color:#F07178;">      plugins</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">plugins</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">map</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">name</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;">// 预构建配置</span></span>
<span class="line"><span style="color:#F07178;">      optimizeDeps</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        include</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">optimizeDeps</span><span style="color:#89DDFF;">?.</span><span style="color:#A6ACCD;">include</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">        exclude</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">optimizeDeps</span><span style="color:#89DDFF;">?.</span><span style="color:#A6ACCD;">exclude</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// 特殊处理函数和正则类型</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">_</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">value</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">function</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">instanceof</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">RegExp</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">value</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toString</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">value</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">  )</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 最后调用 crypto 库中的 createHash 方法生成哈希</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">createHash</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">sha256</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">update</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">content</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">digest</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">hex</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">substring</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">8</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="依赖扫描" tabindex="-1">依赖扫描 <a class="header-anchor" href="#依赖扫描" aria-hidden="true">#</a></h3><p>如果没有命中缓存，则会正式地进入依赖预构建阶段。</p><p>但在此之前，Vite 仍然需要探测项目中存在哪些依赖，并收集依赖列表，这就是依赖扫描的过程。这个过程是必须的，因为 Esbuild 需要知道到底要打包哪些第三方依赖，关键代码如下：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> deps</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> missing </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">await</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">scanImports</span><span style="color:#A6ACCD;">(config))</span></span>
<span class="line"></span></code></pre></div><p>在 <code>scanImports</code> 方法内部主要会调用 Esbuild 提供的 build 方法：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> deps</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Record</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#676E95;">// 扫描用到的 Esbuild 插件</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> plugin </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">esbuildScanPlugin</span><span style="color:#A6ACCD;">(config</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> container</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> deps</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> missing</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> entries)</span></span>
<span class="line"><span style="color:#89DDFF;">await</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Promise</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">all</span><span style="color:#A6ACCD;">(</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 应用项目入口</span></span>
<span class="line"><span style="color:#A6ACCD;">  entries</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">map</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">entry</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">build</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">absWorkingDir</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> process</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">cwd</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;">// 注意这个参数</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">write</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">entryPoints</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> [entry]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">bundle</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">format</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">esm</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">logLevel</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">error</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">plugins</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> [</span><span style="color:#89DDFF;">...</span><span style="color:#A6ACCD;">plugins</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> plugin]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">...</span><span style="color:#A6ACCD;">esbuildOptions</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  )</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span></code></pre></div><p>其中传入的 <code>write</code> 设定为 <code>false</code> ，表示产物不用写入磁盘，这样大大节省了磁盘 I / O 的时间，这也是依赖扫描往往比依赖打包快很多的原因之一。</p><p>接下来输出预打包信息：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">asCommand) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">newDeps</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">logger</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">info</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">chalk</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">greenBright</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">Pre-bundling dependencies:</span><span style="color:#A6ACCD;">\n</span><span style="color:#C3E88D;">  </span><span style="color:#89DDFF;">${</span><span style="color:#A6ACCD;">depsString</span><span style="color:#89DDFF;">}`</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    )</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">logger</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">info</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">(this will be run only when your dependencies or config have changed)</span><span style="color:#89DDFF;">`</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    )</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">logger</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">info</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">chalk</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">greenBright</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">Optimizing dependencies:</span><span style="color:#A6ACCD;">\n</span><span style="color:#C3E88D;">  </span><span style="color:#89DDFF;">${</span><span style="color:#A6ACCD;">depsString</span><span style="color:#89DDFF;">}`</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>第一次启动时，会输出预构建相关的 log 信息，这些信息都是通过依赖扫描阶段收集的，此时还并未开始真正的依赖打包过程。</p><p>为什么对项目入口打包一次就收集到所有依赖信息的原因：<code>esbuildScanPlugin</code> 这个函数创建 <code>scan 插件</code>时，接收了 <code>deps</code> 对象最为入参，这个对象的作用是在 <code>scan 插件</code>里解析各种 import 语句，最终通过它来记录依赖信息。</p><h3 id="依赖打包" tabindex="-1">依赖打包 <a class="header-anchor" href="#依赖打包" aria-hidden="true">#</a></h3><p>收集完依赖后，正式进入依赖打包阶段。</p><p>这里调用 Ebuild 进行打包并写入产物到磁盘中，关键代码如下：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> result </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">await</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">build</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">absWorkingDir</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> process</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">cwd</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 所有依赖的 id 数组，在插件中会转换为真实的路径</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">entryPoints</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> Object</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">keys</span><span style="color:#A6ACCD;">(flatIdDeps)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">bundle</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">format</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">esm</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">target</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">build</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">target </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">undefined,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">external</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">optimizeDeps</span><span style="color:#89DDFF;">?.</span><span style="color:#A6ACCD;">exclude</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">logLevel</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">error</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">splitting</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">sourcemap</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">outdir</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> cacheDir</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">ignoreAnnotations</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">metafile</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  define</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">plugins</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> [</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">...</span><span style="color:#A6ACCD;">plugins</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// 预构建专用的插件</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">esbuildDepPlugin</span><span style="color:#A6ACCD;">(flatIdDeps</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> flatIdToExports</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> config</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> ssr)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  ]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">...</span><span style="color:#A6ACCD;">esbuildOptions</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#676E95;">// 打包元信息，后续会根据这份信息生成 _metadata.json</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> meta </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> result</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">metafile</span><span style="color:#89DDFF;">!</span></span>
<span class="line"></span></code></pre></div><h3 id="元信息写入磁盘" tabindex="-1">元信息写入磁盘 <a class="header-anchor" href="#元信息写入磁盘" aria-hidden="true">#</a></h3><p>在打包完成后，Vite 会拿到 Esbuild 构建的元信息，就是上面代码中的 <code>meta</code> 对象，然后将元信息保存到 <code>_metadata.json</code> 文件中：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">DepOptimizationMetadata</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">hash</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> mainHash</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">browserHash</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> mainHash</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">optimized</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{},</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#676E95;">// 省略中间的代码</span></span>
<span class="line"><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> (</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">in</span><span style="color:#A6ACCD;"> deps) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">entry</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">deps</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;">]</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">optimized</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    file</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">normalizePath</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resolve</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">cacheDir</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">flattenId</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">))</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    src</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">entry</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// 判断是否需要转换成 ESM 格式，后面会介绍</span></span>
<span class="line"><span style="color:#F07178;">    needsInterop</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">needsInterop</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">idToExports</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">meta</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">outputs</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">cacheDirOutputPath</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    )</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#676E95;">// 元信息写磁盘</span></span>
<span class="line"><span style="color:#82AAFF;">writeFile</span><span style="color:#A6ACCD;">(dataPath</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> JSON</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">stringify</span><span style="color:#A6ACCD;">(data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">))</span></span>
<span class="line"></span></code></pre></div><h2 id="依赖扫描-1" tabindex="-1">依赖扫描 <a class="header-anchor" href="#依赖扫描-1" aria-hidden="true">#</a></h2><h3 id="获取入口" tabindex="-1">获取入口 <a class="header-anchor" href="#获取入口" aria-hidden="true">#</a></h3><p>首先关注 <code>scanImports</code> 的实现。</p><p>进行依赖扫描之前，需要找到入口文件，但入口文件可能存在于多个配置当中，比如 <code>optimizeDeps.entries</code> 和 <code>build.rollupOptions.input</code> ，同时需要考虑数组和对象的情况，但可能用户没有配置，需要自动探测入口文件：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> explicitEntryPatterns </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">optimizeDeps</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">entries</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> buildInput </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">build</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">rollupOptions</span><span style="color:#89DDFF;">?.</span><span style="color:#A6ACCD;">input</span></span>
<span class="line"><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> (explicitEntryPatterns) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 先从 optimizeDeps.entries 寻找入口，支持 glob 语法</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">entries</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">globEntries</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">explicitEntryPatterns</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">config</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> (buildInput) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 其次从 build.rollupOptions.input 配置中寻找，注意需要考虑数组和对象的情况</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">resolvePath</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resolve</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">root</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">p</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">buildInput</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">string</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">entries</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> [</span><span style="color:#82AAFF;">resolvePath</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">buildInput</span><span style="color:#F07178;">)]</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">Array</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isArray</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">buildInput</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">entries</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">buildInput</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">map</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">resolvePath</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isObject</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">buildInput</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">entries</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">Object</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">values</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">buildInput</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">map</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">resolvePath</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">throw</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">Error</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">invalid rollupOptions.input value.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 兜底逻辑，如果用户没有进行上述配置，则自动从根目录开始寻找</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">entries</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">globEntries</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">**/*.html</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">config</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p><code>globEntries</code> 方法通过 <code>fast-glob</code> 库从项目根目录扫描文件。</p><p>接下来，需要考虑入口文件类型，一般情况下入口需要是 JS 或 TS 文件，但实际上，像 HTML 、Vue 单文件组件等也需要支持，因为在这些文件中仍然可以包含 script 标签的内容，从而搜集到依赖信息。</p><p>在源码中，同时对 <code>html</code> 、<code>vue</code>、<code>svelte</code>、<code>astro</code> ( 一种新兴的类 HTML 语法 ) 四种后缀的入口文件进行解析，具体的解析过程在依赖扫描阶段的 Esbuild 插件中得以实现。</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> htmlTypesRE </span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">(</span><span style="color:#C3E88D;">html</span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">vue</span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">svelte</span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">astro</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;">$</span><span style="color:#89DDFF;">/</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">esbuildScanPlugin</span><span style="color:#89DDFF;">(</span><span style="color:#676E95;">/* 一些入参 */</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Plugin</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 初始化一些变量</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 返回一个 Esbuild 插件</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    name</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">vite:dep-scan</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    setup</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">build</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;">// 标记「类 HTML」文件的 namespace</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">build</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onResolve</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> filter</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">htmlTypesRE</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">},</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">async</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">({</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">path</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">importer</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">})</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">          path</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">resolve</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">path</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">importer</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          namespace</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">html</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">build</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onLoad</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> filter</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">htmlTypesRE</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> namespace</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">html</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#C792EA;">async</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">({</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">path</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">})</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;">// 解析「类 HTML」文件</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">      )</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>以 HTML 文件的解析为例，在插件中会扫描出所有带有 <code>type=&quot;module&quot;</code> 的 script 标签，对于含有 src 的 script 标签改写为一个 import 语句，对于含有具体内容的 script ，则抽离出其中的脚本内容，最后将所有的 script 内容拼接成一段 JS 代码。</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> scriptModuleRE </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">(&lt;</span><span style="color:#FFCB6B;">script</span><span style="color:#A6ACCD;">\</span><span style="color:#FFCB6B;">b</span><span style="color:#A6ACCD;">[^&gt;]*</span><span style="color:#FFCB6B;">type</span><span style="color:#A6ACCD;">\</span><span style="color:#FFCB6B;">s</span><span style="color:#A6ACCD;">*=\</span><span style="color:#FFCB6B;">s</span><span style="color:#A6ACCD;">*(</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">module</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">module</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)[^&gt;]*&gt;)(</span><span style="color:#89DDFF;">.*?</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">&lt;</span><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">script&gt;</span><span style="color:#89DDFF;">/</span><span style="color:#F78C6C;">gims</span></span>
<span class="line"><span style="color:#A6ACCD;">export const scriptRE </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">(&lt;</span><span style="color:#FFCB6B;">script</span><span style="color:#A6ACCD;">\</span><span style="color:#FFCB6B;">b</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;">\</span><span style="color:#FFCB6B;">s</span><span style="color:#A6ACCD;">[^&gt;]*&gt;</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">&gt;))(.*</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">/</span><span style="color:#FFCB6B;">script</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">/</span><span style="color:#FFCB6B;">gims</span></span>
<span class="line"><span style="color:#FFCB6B;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">commentRE</span><span style="color:#A6ACCD;"> = /</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">!--(.</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">[\</span><span style="color:#FFCB6B;">r</span><span style="color:#A6ACCD;">\</span><span style="color:#FFCB6B;">n</span><span style="color:#A6ACCD;">])*</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;">--</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#FFCB6B;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">srcRE</span><span style="color:#A6ACCD;"> = /\</span><span style="color:#FFCB6B;">bsrc</span><span style="color:#A6ACCD;">\</span><span style="color:#FFCB6B;">s</span><span style="color:#A6ACCD;">*=\</span><span style="color:#FFCB6B;">s</span><span style="color:#A6ACCD;">*(</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> ([^ ]+) </span><span style="color:#89DDFF;">|</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">([^</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">]+)</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">|([^</span><span style="color:#A6ACCD;">\s</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> &gt;]</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">))</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">im</span></span>
<span class="line"><span style="color:#A6ACCD;">const typeRE </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">/</span><span style="color:#89DDFF;">\b</span><span style="color:#C3E88D;">type\s</span><span style="color:#89DDFF;">*</span><span style="color:#C3E88D;">=\s</span><span style="color:#89DDFF;">*(?:</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">([^</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">]+)</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">([^</span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">]+)</span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">|([^</span><span style="color:#C3E88D;">\s&#39; &gt;</span><span style="color:#89DDFF;">]+))/</span><span style="color:#F78C6C;">im</span></span>
<span class="line"><span style="color:#A6ACCD;">const langRE </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">/</span><span style="color:#89DDFF;">\b</span><span style="color:#C3E88D;">lang\s</span><span style="color:#89DDFF;">*</span><span style="color:#C3E88D;">=\s</span><span style="color:#89DDFF;">*(?:</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">([^</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">]+)</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">([^</span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">]+)</span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">|([^</span><span style="color:#C3E88D;">\s&#39; &gt;</span><span style="color:#89DDFF;">]+))/</span><span style="color:#F78C6C;">im</span></span>
<span class="line"><span style="color:#676E95;">// scan 插件 setup 方法内部实现</span></span>
<span class="line"><span style="color:#A6ACCD;">build</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onLoad</span><span style="color:#A6ACCD;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">filter</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> htmlTypesRE</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">html</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">({</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">path</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">})</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">raw</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readFileSync</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">path</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">utf-8</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// 去掉注释内容，防止干扰解析过程</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">raw</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">raw</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">replace</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">commentRE</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">&lt;!----&gt;</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">isHtml</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">endsWith</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">.html</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// HTML 情况下会寻找 type 为 module 的 script</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// 正则：/(&lt;script\b[^&gt;]*type\s*=\s*(?: module |&#39;module&#39;)[^&gt;]*&gt;)(.*?)&lt;/script&gt;/gims</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">regex</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">isHtml</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">scriptModuleRE</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">scriptRE</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">regex</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">lastIndex</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">js</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">loader</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">Loader</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">js</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">match</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">RegExpExecArray</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">null</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// 正式开始解析</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">while</span><span style="color:#F07178;"> ((</span><span style="color:#A6ACCD;">match</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">regex</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">exec</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">raw</span><span style="color:#F07178;">))) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;">// 第一次: openTag 为 &lt;script type= module  src= /src/main.ts &gt;, 无 content</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;">// 第二次: openTag 为 &lt;script type= module &gt;，有 content</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">[,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">openTag</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">content</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">match</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">typeMatch</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">openTag</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">match</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">typeRE</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">type</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">typeMatch</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">typeMatch</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">1</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">typeMatch</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">2</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">typeMatch</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">3</span><span style="color:#F07178;">])</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">langMatch</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">openTag</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">match</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">langRE</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">lang</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">langMatch</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">langMatch</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">1</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">langMatch</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">2</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">langMatch</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">3</span><span style="color:#F07178;">])</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">lang</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">ts</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">lang</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">tsx</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">lang</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">jsx</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// 指定 esbuild 的 loader</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">loader</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">lang</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">srcMatch</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">openTag</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">match</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">srcRE</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;">// 根据有无 src 属性来进行不同的处理</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">srcMatch</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">src</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">srcMatch</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">1</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">srcMatch</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">2</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">srcMatch</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">3</span><span style="color:#F07178;">]</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">js</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">import </span><span style="color:#89DDFF;">${</span><span style="color:#A6ACCD;">JSON</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">stringify</span><span style="color:#A6ACCD;">(src)</span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">`</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">content</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">trim</span><span style="color:#F07178;">()) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">js</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">content</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">loader</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    contents</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">)</span></span>
<span class="line"></span></code></pre></div><p>这里对源码做了一定的精简，省略了 <code>.vue</code> 、<code>.svelte</code> 和 <code>i<wbr>mport.meta.glob</code> 语法的处理，但不影响整体的实现思路，这里说明的是即使是 HTML 或者类似类型的文件，也能作为 Esbuild 预构建入口来进行解析。</p><h3 id="记录依赖" tabindex="-1">记录依赖 <a class="header-anchor" href="#记录依赖" aria-hidden="true">#</a></h3><p>Vite 中会把 <code>bare import</code> 的路径当作依赖路径，<code>bare import</code> 就是直接引入一个包名：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> React </span><span style="color:#89DDFF;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">react</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span></code></pre></div><p>而 <code>.</code> 开头的相对路径或者以 <code>/</code> 开头的绝对路径都不能算 <code>bare import</code> ：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// 以下都不是 bare import</span></span>
<span class="line"><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> React </span><span style="color:#89DDFF;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">../node_modules/react/index.js</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> React </span><span style="color:#89DDFF;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/User/sanyuan/vite-project/node_modules/react/index.js</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span></code></pre></div><p>解析 <code>bare import</code> ，记录依赖的逻辑依然在 scan 插件中：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">build</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onResolve</span><span style="color:#A6ACCD;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// avoid matching windows volume</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">filter</span><span style="color:#89DDFF;">:</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">/</span><span style="color:#89DDFF;">^</span><span style="color:#89DDFF;">[</span><span style="color:#C3E88D;">\w@</span><span style="color:#89DDFF;">][^</span><span style="color:#C3E88D;">:</span><span style="color:#89DDFF;">]/</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">({</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">importer</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">})</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// 如果在 optimizeDeps.exclude 列表或者已经记录过了，则将其 externalize (排除)，直接 return</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// 接下来解析路径，内部调用各个插件的 resolveId 方法进行解析</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">resolved</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">resolve</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">importer</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">resolved</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;">// 判断是否应该 externalize，下个部分详细拆解</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">shouldExternalizeDep</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">resolved</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">externalUnlessEntry</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> path</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">resolved</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">includes</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">node_modules</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">include</span><span style="color:#89DDFF;">?.</span><span style="color:#82AAFF;">includes</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// 如果 resolved 为 js 或 ts 文件</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">OPTIMIZABLE_ENTRY_RE</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">test</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">resolved</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;">// 注意了! 现在将其正式地记录在依赖表中</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">depImports</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">resolved</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// 进行 externalize，因为这里只用扫描出依赖即可，不需要进行打包，具体实现后面的部分会讲到</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">externalUnlessEntry</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> path</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// resolved 为 「类 html」 文件，则标记上 &#39;html&#39; 的 namespace</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">namespace</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">htmlTypesRE</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">test</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">resolved</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">html</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">undefined</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// linked package, keep crawling</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">          path</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resolve</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">resolved</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">namespace</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;">// 没有解析到路径，记录到 missing 表中，后续会检测这张表，显示相关路径未找到的报错</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">missing</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">normalizePath</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">importer</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span></code></pre></div><p>其中调用到了 <code>resolve</code> ，也就是路径解析的逻辑，这里面实际上会调用各个插件的 <code>resolvedId</code> 方法进行路径解析：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> resolve </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">importer</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 通过 seen 对象进行路径缓存</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">key</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">importer</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">dirname</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">importer</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">seen</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">has</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">key</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">seen</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">key</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 调用插件容器的 resolveId</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 关于插件容器下一节会详细介绍，这里你直接理解为调用各个插件的 resolveId 方法解析路径即可</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">resolved</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">container</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resolveId</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">importer</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">normalizePath</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">importer</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  )</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">res</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">resolved</span><span style="color:#89DDFF;">?.</span><span style="color:#A6ACCD;">id</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">seen</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">set</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">key</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">res</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">res</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="external-规则" tabindex="-1">external 规则 <a class="header-anchor" href="#external-规则" aria-hidden="true">#</a></h3><p>上面分析了在 Esbuild 插件中如何针对 <code>bare import</code> 记录依赖，在记录过程中需要决定哪些路径应该被排除、不应该被记录或者不应该被 Esbuild 解析。这就是 external 规则的概念。</p><p>external 的路径分为两类：资源型和模块型。</p><p>对于资源型的路径，一般是直接排除，在插件中的处理方式如下：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// data url，直接标记 external: true，不让 esbuild 继续处理</span></span>
<span class="line"><span style="color:#A6ACCD;">build</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onResolve</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">filter</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> dataUrlRE </span><span style="color:#89DDFF;">},</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">({</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">path</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">})</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  path</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">external</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">))</span></span>
<span class="line"><span style="color:#676E95;">// 加了 ?worker 或者 ?raw 这种 query 的资源路径，直接 external</span></span>
<span class="line"><span style="color:#A6ACCD;">build</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onResolve</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">filter</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> SPECIAL_QUERY_RE </span><span style="color:#89DDFF;">},</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">({</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">path</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">})</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  path</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">external</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">))</span></span>
<span class="line"><span style="color:#676E95;">// css &amp; json</span></span>
<span class="line"><span style="color:#A6ACCD;">build</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onResolve</span><span style="color:#A6ACCD;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">filter</span><span style="color:#89DDFF;">:</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">(</span><span style="color:#C3E88D;">css</span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">less</span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">sass</span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">scss</span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">styl</span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">stylus</span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">pcss</span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">postcss</span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">json</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;">$</span><span style="color:#89DDFF;">/</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 非 entry 则直接标记 external</span></span>
<span class="line"><span style="color:#A6ACCD;">  externalUnlessEntry</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#676E95;">// Vite 内置的一些资源类型，比如 .png、.wasm 等等</span></span>
<span class="line"><span style="color:#A6ACCD;">build</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onResolve</span><span style="color:#A6ACCD;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">filter</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">RegExp</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">\.</span><span style="color:#C3E88D;">(</span><span style="color:#89DDFF;">${</span><span style="color:#A6ACCD;">KNOWN_ASSET_TYPES</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">|</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">)$</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 非 entry 则直接标记 external</span></span>
<span class="line"><span style="color:#A6ACCD;">  externalUnlessEntry</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> externalUnlessEntry </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">({</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">path</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">})</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  path</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 非 entry 则标记 external</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">external</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">entries</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">includes</span><span style="color:#A6ACCD;">(path)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span></code></pre></div><p>对于模块型的路径，也就是当通过 <code>resolve</code> 函数解析出一个 JS 模块的路径，在 <code>shouldExternalizeDep</code> 中实现：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#89DDFF;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">shouldExternalizeDep</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;">resolvedId</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;">rawId</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 解析之后不是一个绝对路径，不在 esbuild 中进行加载</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isAbsolute</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">resolvedId</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 1. import 路径本身就是一个绝对路径</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 2. 虚拟模块(Rollup 插件中约定虚拟模块以`\0`开头)</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 都不在 esbuild 中进行加载</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">resolvedId</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">rawId</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">resolvedId</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">includes</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">\0</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 不是 JS 或者 类 HTML 文件，不在 esbuild 中进行加载</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">JS_TYPES_RE</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">test</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">resolvedId</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">htmlTypesRE</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">test</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">resolvedId</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="依赖打包-1" tabindex="-1">依赖打包 <a class="header-anchor" href="#依赖打包-1" aria-hidden="true">#</a></h2><h3 id="扁平化产物文件结构" tabindex="-1">扁平化产物文件结构 <a class="header-anchor" href="#扁平化产物文件结构" aria-hidden="true">#</a></h3><p>一般情况下，Esbuild 输出嵌套的产物目录结构，比如 Vue ，其产物在 <code>dist/vue.runtime.esm-bundler.js</code> 中，在经过 Esbuild 正常打包后，预构建产物目录如下：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">node_modules/.vite</span></span>
<span class="line"><span style="color:#A6ACCD;">├── _metadata.json</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue</span></span>
<span class="line"><span style="color:#A6ACCD;">│   └── dist</span></span>
<span class="line"><span style="color:#A6ACCD;">│       └── vue.runtime.esm-bundler.js</span></span>
<span class="line"></span></code></pre></div><p>由于各个第三方包的产物目录结构不一致，深层次的嵌套目录对于 Vite 的路径解析增加了麻烦和不可控因素。为了解决嵌套目录带来的问题，Vite 做了两件事达到扁平化预构建产物输出：</p><ol><li>嵌套路径扁平化：<code>/</code> 被换成下划线，如 <code>react/jsx-dev-runtime</code> ，被重写为 <code>react_jsx-dev-runtime</code> 。</li><li>用虚拟模块代替真实模块，作为预打包的入口。</li></ol><p>在 <code>optimizeDeps</code> 函数中，在进行完依赖扫描的步骤后，会执行路径扁平化操作：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> flatIdDeps</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Record</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> idToExports</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Record</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ExportsData</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> flatIdToExports</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Record</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ExportsData</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#676E95;">// deps 即为扫描后的依赖表</span></span>
<span class="line"><span style="color:#676E95;">// 形如: {</span></span>
<span class="line"><span style="color:#676E95;">//    react :  /Users/sanyuan/vite-project/react/index.js  }</span></span>
<span class="line"><span style="color:#676E95;">//    react/jsx-dev-runtime :  /Users/sanyuan/vite-project/react/jsx-dev-runtime.js</span></span>
<span class="line"><span style="color:#676E95;">// }</span></span>
<span class="line"><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> (</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">in</span><span style="color:#A6ACCD;"> deps) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 扁平化路径，`react/jsx-dev-runtime`，被重写为`react_jsx-dev-runtime`；</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">flatId</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">flattenId</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 填入 flatIdDeps 表，记录 flatId -&gt; 真实路径的映射关系</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">filePath</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">flatIdDeps</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">flatId</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">deps</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;">])</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">entryContent</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readFileSync</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">filePath</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">utf-8</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 后续代码省略</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>对于虚拟模块的处理，关注 <code>esbuildDepPlugin</code> 函数：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#89DDFF;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">esbuildDepPlugin</span><span style="color:#89DDFF;">(</span><span style="color:#676E95;">/* 一些传参 */</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 定义路径解析的方法</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 返回 Esbuild 插件</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    name</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">vite:dep-pre-bundle</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    set</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">build</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;">// bare import 的路径</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">build</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onResolve</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> filter</span><span style="color:#89DDFF;">:</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">/</span><span style="color:#89DDFF;">^</span><span style="color:#89DDFF;">[</span><span style="color:#C3E88D;">\w@</span><span style="color:#89DDFF;">][^</span><span style="color:#C3E88D;">:</span><span style="color:#89DDFF;">]/</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#C792EA;">async</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">({</span><span style="color:#F07178;"> path</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">importer</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">kind</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">})</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;">// 判断是否为入口模块，如果是，则标记上`dep`的 namespace，成为一个虚拟模块</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">build</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onLoad</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> filter</span><span style="color:#89DDFF;">:</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">*/</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> namespace</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">dep</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">},</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">({</span><span style="color:#F07178;"> path</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">})</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;">// 加载虚拟模块</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  }</span></span>
<span class="line"><span style="color:#F07178;">}</span></span>
<span class="line"></span></code></pre></div><p>如此一来，Esbuild 会将虚拟模块作为入口进行打包，最后的产物目录会变成下面的扁平结构：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">node_modules/.vite</span></span>
<span class="line"><span style="color:#A6ACCD;">├── _metadata.json</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── react.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── react_jsx-dev-runtime.js</span></span>
<span class="line"></span></code></pre></div><h3 id="代理模块加载" tabindex="-1">代理模块加载 <a class="header-anchor" href="#代理模块加载" aria-hidden="true">#</a></h3><p>虚拟模块代替了真实模块作为打包入口，所以也可以理解为代理模块。</p><p>以 <code>import React from &quot;react&quot;</code> 为例，Vite 会把 <code>react</code> 标记为 <code>namespace</code> 为 <code>dep</code> 的虚拟模块，然后控制 Esbuild 的加载流程，对于真实模块的内容进行重新导出。</p><p>首先是，确定真实模块的路径：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// 真实模块所在的路径，拿 react 来说，即`node_modules/react/index.js`</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> entryFile </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> qualified[id]</span></span>
<span class="line"><span style="color:#676E95;">// 确定相对路径</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> relativePath </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">normalizePath</span><span style="color:#A6ACCD;">(path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">relative</span><span style="color:#A6ACCD;">(root</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> entryFile))</span></span>
<span class="line"><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> (</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">relativePath</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">startsWith</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">./</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">) </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">relativePath</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">startsWith</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">../</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">) </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#A6ACCD;">  relativePath </span><span style="color:#89DDFF;">!==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">relativePath</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">./</span><span style="color:#89DDFF;">${</span><span style="color:#A6ACCD;">relativePath</span><span style="color:#89DDFF;">}`</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>确定路径后，对模块的内容进行重新导出：</p><ol><li>CJS</li><li>ESM</li></ol><p>在 <code>optimizeDeps</code> 中，实际上在进行真正的依赖打包之前，Vite 会读取各个依赖的入口文件，通过 <code>es-module-lexer</code> 解析入口文件的内容。</p><p><code>es-module-lexer</code> 是一个在解析 ES 导入导出语法的库，大致用法如下：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">init</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">parse</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">es-module-lexer</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#676E95;">// 等待`es-module-lexer`初始化完成</span></span>
<span class="line"><span style="color:#89DDFF;">await</span><span style="color:#A6ACCD;"> init</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> sourceStr </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span></span>
<span class="line"><span style="color:#C3E88D;">  import moduleA from &#39;./a&#39;;</span></span>
<span class="line"><span style="color:#C3E88D;">  export * from &#39;b&#39;;</span></span>
<span class="line"><span style="color:#C3E88D;">  export const count = 1;</span></span>
<span class="line"><span style="color:#C3E88D;">  export default count;</span></span>
<span class="line"><span style="color:#89DDFF;">`</span></span>
<span class="line"><span style="color:#676E95;">// 开始解析</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> exportsData </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">parse</span><span style="color:#A6ACCD;">(sourceStr)</span></span>
<span class="line"><span style="color:#676E95;">// 结果为一个数组，分别保存 import 和 export 的信息</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">imports</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> exports</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> exportsData</span></span>
<span class="line"><span style="color:#676E95;">// 返回 `import module from &#39;./a&#39;`</span></span>
<span class="line"><span style="color:#A6ACCD;">sourceStr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">substring</span><span style="color:#A6ACCD;">(imports[</span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">]</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">ss</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> imports[</span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">]</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">se)</span></span>
<span class="line"><span style="color:#676E95;">// 返回 [&#39;count&#39;, &#39;default&#39;]</span></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">exports</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span></code></pre></div><p><code>export * from </code> 导出的语法会被记录在 import 信息中。</p><p><code>optimizeDeps</code> 利用 <code>es-module-lexer</code> 解析入口文件的实现：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">init</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">parse</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">es-module-lexer</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#676E95;">// 省略中间的代码</span></span>
<span class="line"><span style="color:#89DDFF;">await</span><span style="color:#A6ACCD;"> init</span></span>
<span class="line"><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> (</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">in</span><span style="color:#A6ACCD;"> deps) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 省略前面的路径扁平化逻辑</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 读取入口内容</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">entryContent</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readFileSync</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">filePath</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">utf-8</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">try</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">exportsData</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">parse</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">entryContent</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">ExportsData</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">catch</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// 省略对 jsx 的处理</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ss</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">se</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">of</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">exportsData</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">]) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">exp</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">entryContent</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">slice</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">ss</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">se</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// 标记存在 `export * from` 语法</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">export\s</span><span style="color:#89DDFF;">+*</span><span style="color:#C3E88D;">\s</span><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">from</span><span style="color:#89DDFF;">/</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">test</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">exp</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">exportsData</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">hasReExports</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 将 import 和 export 信息记录下来</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">idToExports</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">exportsData</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">flatIdToExports</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">flatId</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">exportsData</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>由于最后会有两张表记录下 ES 模块导入和导出的相关信息，而 flatIdToExports 表会作为入参传给 Esbuild 插件:</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// 第二个入参</span></span>
<span class="line"><span style="color:#82AAFF;">esbuildDepPlugin</span><span style="color:#A6ACCD;">(flatIdDeps</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> flatIdToExports</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> config</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> ssr)</span></span>
<span class="line"></span></code></pre></div><p>如此，就能根据真实模块的路径获取到导入和导出的信息，通过这份信息来甄别 CommonJS 和 ES 两种模块规范。现在可以回到 Esbuild 打包插件中加载代理模块的代码:</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> contents </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;&quot;</span></span>
<span class="line"><span style="color:#676E95;">// 下面的 exportsData 即外部传入的模块导入导出相关的信息表</span></span>
<span class="line"><span style="color:#676E95;">// 根据模块 id 拿到对应的导入导出信息</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> data </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> exportsData[id]</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">imports</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> exports</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> data</span></span>
<span class="line"><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">imports</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!exports.</span><span style="color:#A6ACCD;">length) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 处理 CommonJS 模块</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 处理 ES  模块</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>如果是 CommonJS 模块，则导出语句写成这种形式:</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> contents </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">contents </span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">export default require( </span><span style="color:#89DDFF;">${</span><span style="color:#A6ACCD;">relativePath</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;"> );</span><span style="color:#89DDFF;">`</span></span>
<span class="line"></span></code></pre></div><p>如果是 ES 模块，则分默认导出和非默认导出这两种情况来处理:</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// 默认导出，即存在 export default 语法</span></span>
<span class="line"><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">exports.</span><span style="color:#82AAFF;">includes</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">default</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">contents</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">import d from  </span><span style="color:#89DDFF;">${</span><span style="color:#A6ACCD;">relativePath</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;"> ;export default d;</span><span style="color:#89DDFF;">`</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#676E95;">// 非默认导出</span></span>
<span class="line"><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> (</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 1. 存在 `export * from` 语法，前文分析过</span></span>
<span class="line"><span style="color:#A6ACCD;">  data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">hasReExports </span><span style="color:#89DDFF;">||</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 2. 多个导出内容</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">exports.</span><span style="color:#A6ACCD;">length </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 3. 只有一个导出内容，但这个导出不是 export default</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">exports</span><span style="color:#A6ACCD;">[</span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">] </span><span style="color:#89DDFF;">!==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">default</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 凡是命中上述三种情况中的一种，则添加下面的重导出语句</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">contents</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">\n</span><span style="color:#C3E88D;">export * from  </span><span style="color:#89DDFF;">${</span><span style="color:#A6ACCD;">relativePath</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">`</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>现在，组装好了代理模块的内容，接下来就可以放心地交给 Esbuild 加载了:</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> ext </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">extname</span><span style="color:#A6ACCD;">(entryFile)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">slice</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> (ext </span><span style="color:#89DDFF;">===</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">mjs</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">) ext </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">js</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">loader</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> ext </span><span style="color:#89DDFF;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Loader</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 虚拟模块内容</span></span>
<span class="line"><span style="color:#A6ACCD;">  contents</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">resolveDir</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> root</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="代理模块为什么要和真实模块分离" tabindex="-1">代理模块为什么要和真实模块分离？ <a class="header-anchor" href="#代理模块为什么要和真实模块分离" aria-hidden="true">#</a></h4><p>现在已经清楚了 Vite 是如何组装代理模块，以此作为 Esbuild 打包入口的，整体的思路就是先分析一遍模块真实入口文件的 import 和 export 语法，然后在代理模块中进行重导出。这里不妨回过头来思考一下: 为什么要对真实文件先做语法分析，然后重导出内容呢？</p><p>对此，大家不妨注意一下代码中的这段注释:</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// It is necessary to do the re-exporting to separate the virtual proxy</span></span>
<span class="line"><span style="color:#676E95;">// module from the actual module since the actual module may get</span></span>
<span class="line"><span style="color:#676E95;">// referenced via relative imports - if we don&#39;t separate the proxy and</span></span>
<span class="line"><span style="color:#676E95;">// the actual module, esbuild will create duplicated copies of the same</span></span>
<span class="line"><span style="color:#676E95;">// module!</span></span>
<span class="line"></span></code></pre></div><p>翻译过来即:</p><blockquote><p>这种重导出的做法是必要的，它可以分离虚拟模块和真实模块，因为真实模块可以通过相对地址来引入。如果不这么做，Esbuild 将会对打包输出两个一样的模块。</p></blockquote><p>如果代理模块通过文件系统直接读取真实模块的内容，而不是进行重导出，因此由于此时代理模块跟真实模块并没有任何的引用关系，这就导致最后的 react.js 和 @emotion/react.js 两份产物并不会引用同一份 Chunk，Esbuild 最后打包出了内容完全相同的两个 Chunk！</p><p>这也就能解释为什么 Vite 中要在代理模块中对真实模块的内容进行重导出了，主要是为了避免 Esbuild 产生重复的打包内容。</p></div></div></main><!--[--><!--]--><footer class="VPDocFooter" data-v-7dd55a9c data-v-edc4fadc><div class="edit-info" data-v-edc4fadc><!----><div class="last-updated" data-v-edc4fadc><p class="VPLastUpdated" data-v-edc4fadc data-v-5ce65bc4>Last updated: <time datetime="2022-11-28T01:42:11.000Z" data-v-5ce65bc4></time></p></div></div><div class="prev-next" data-v-edc4fadc><div class="pager" data-v-edc4fadc><a class="pager-link prev" href="/toolchain/vite/config.html" data-v-edc4fadc><span class="desc" data-v-edc4fadc>Previous page</span><span class="title" data-v-edc4fadc>配置解析</span></a></div><div class="has-prev pager" data-v-edc4fadc><a class="pager-link next" href="/toolchain/vite/pluginPipeline.html" data-v-edc4fadc><span class="desc" data-v-edc4fadc>Next page</span><span class="title" data-v-edc4fadc>插件流水线</span></a></div></div></footer><!--[--><!--]--></div></div></div></div></div><!----><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"algorithm_1-twosum.md\":\"74db9f81\",\"algorithm_100-sametree.md\":\"55b26e90\",\"algorithm_101-symmetrictree.md\":\"7873761b\",\"algorithm_102-binarytreelevelordertraversal.md\":\"96215b16\",\"algorithm_104-maximumdepthofbinarytree.md\":\"f340fb7e\",\"algorithm_1047-removealladjacentduplicatesinstring.md\":\"70457bad\",\"algorithm_107-binarytreelevelordertravsal2.md\":\"1379a1de\",\"algorithm_108-convertsortedarraytobinarysearchtree.md\":\"7d8a5b43\",\"algorithm_109-convertsortedlisttobinarysearchtree.md\":\"03377f89\",\"algorithm_110-balancedbinarytree.md\":\"f8bb6a3a\",\"algorithm_111-minimundepthofbinarytree.md\":\"f62d46a0\",\"algorithm_112-pathsum.md\":\"673b1c3c\",\"algorithm_114-flattenbinarytreetolinkedlist.md\":\"c9962e5f\",\"algorithm_116-populatingnextrightpointersineachnode.md\":\"1708a580\",\"algorithm_117-populatingnextrightpointersineachnode2.md\":\"d63020a8\",\"algorithm_125-validpalindrome.md\":\"896176e9\",\"algorithm_131-palindromepartitioning.md\":\"e4061074\",\"algorithm_136-singlenumber.md\":\"15300d65\",\"algorithm_141-linkedlistcycle.md\":\"3dd49d2f\",\"algorithm_142-linkedlistcycle2.md\":\"99cfa9bb\",\"algorithm_144-binarytreepreordertraversal.md\":\"71232ffe\",\"algorithm_145-binarytreepostordertraversal.md\":\"1edfd517\",\"algorithm_146-lrucache.md\":\"01d10eec\",\"algorithm_15-3sum.md\":\"43ffbed5\",\"algorithm_150-evaluatereversepolishnotation.md\":\"1ace6f4c\",\"algorithm_151-reversewordsinastring.md\":\"15a5f365\",\"algorithm_153-findminimuminrotatedsortedarray.md\":\"bce51de1\",\"algorithm_160-intersectionoftwolinkedlist.md\":\"ce2eab18\",\"algorithm_167-twosum2inputissortedarray.md\":\"d03efdb0\",\"algorithm_17-lettercombinationsofaphonenumber.md\":\"eea1aaaa\",\"algorithm_19-removenthnodefromendoflist.md\":\"05de547f\",\"algorithm_199-binarytreerightsideview.md\":\"73404bcb\",\"algorithm_20-validparentheses.md\":\"6399855f\",\"algorithm_203-removelinkedlistelements.md\":\"05236e72\",\"algorithm_206-reverselinkedlist.md\":\"8b55d80d\",\"algorithm_209-minimumsizesubarraysum.md\":\"6f4f2ed0\",\"algorithm_21-mergetwosortedlist.md\":\"bbc08849\",\"algorithm_222-countcompletetreenode.md\":\"ebc546ce\",\"algorithm_225-implementstackusingqueues.md\":\"0c2ad4c4\",\"algorithm_226-invertbinarytree.md\":\"547222dc\",\"algorithm_230-kthsmallestelementinabst.md\":\"3c0a808c\",\"algorithm_231-poweroftwo.md\":\"cbf0633d\",\"algorithm_232-implementqueueusingstacks.md\":\"6538c93f\",\"algorithm_234-palindromelinkedlist.md\":\"4571c575\",\"algorithm_236-lowestcommonancestorofabinarytree.md\":\"6736cc07\",\"algorithm_257-binarytreepaths.md\":\"4ba74801\",\"algorithm_26-removeduplicatesfromsortedarray.md\":\"ab18dbad\",\"algorithm_27-removeelement.md\":\"33a350e9\",\"algorithm_283-movezeros.md\":\"a4e09c1c\",\"algorithm_300-longestincreasingsubsequence.md\":\"47674cf7\",\"algorithm_322-coinchange.md\":\"abc0c2f1\",\"algorithm_344-reversestring.md\":\"c223762a\",\"algorithm_37-sudokusolver.md\":\"5a4d86b3\",\"algorithm_39-combinationsum.md\":\"c4d3c07b\",\"algorithm_404-sumofleftleaves.md\":\"5407712c\",\"algorithm_429-narytreelevelordertraversal.md\":\"6f38b428\",\"algorithm_435-nonoverlappingintervals.md\":\"4968f67d\",\"algorithm_45-jumpgameii.md\":\"c5e14641\",\"algorithm_452-minimumnumberofarrowstoburstballoons.md\":\"4e6abf88\",\"algorithm_455-assigncookies.md\":\"e437dffa\",\"algorithm_46-permutations.md\":\"56cc1adc\",\"algorithm_47-permutations-ii.md\":\"d5c14345\",\"algorithm_509-fibonaccinumber.md\":\"337970cd\",\"algorithm_51-nqueens.md\":\"8b811cf5\",\"algorithm_515-findlargestvalueineachtreerow.md\":\"8d98faa2\",\"algorithm_543-diameterofbinarytree.md\":\"5b989849\",\"algorithm_55-jumpgame.md\":\"5d0e447f\",\"algorithm_572-subtreeofanothertree.md\":\"579e0bb2\",\"algorithm_617-mergetwobinarytrees.md\":\"9fc54e35\",\"algorithm_637-averageoflevelsinbinarytree.md\":\"dfcd5913\",\"algorithm_654-maximumbinarytree.md\":\"fad6abc6\",\"algorithm_69-sqrtx.md\":\"24e13dcf\",\"algorithm_700-searchinabinarysearchtree.md\":\"5e4e993a\",\"algorithm_701-insertintoabinarysearchtree.md\":\"bf129b4f\",\"algorithm_704-binarysearch.md\":\"ef6bbaa0\",\"algorithm_71-simplifypath.md\":\"91a87133\",\"algorithm_77-combinations.md\":\"3ea7d5e5\",\"algorithm_78-subsets.md\":\"51540ad5\",\"algorithm_79-wordsearch.md\":\"1ec7aaf4\",\"algorithm_860-lemonadechange.md\":\"641aedb0\",\"algorithm_876-middleofthelinkedlist.md\":\"aa795d3c\",\"algorithm_92-reverselinkedlist2.md\":\"4a034e4e\",\"algorithm_93-restoreipaddresses.md\":\"5d891e7e\",\"algorithm_94-binarytreeinordertraversal.md\":\"04c56d98\",\"algorithm_977-squaresofasortedarray.md\":\"3b285bfc\",\"algorithm_98-validatebinarysearchtree.md\":\"bda269f4\",\"algorithm_99-recoverbinarysearchtree.md\":\"575af6d6\",\"algorithm_bubblesort.md\":\"d1e04114\",\"algorithm_index.md\":\"adee06fc\",\"algorithm_leftpad.md\":\"0c3cb01d\",\"algorithm_quicksort.md\":\"5c3293f4\",\"algorithm_quicksortinplace.md\":\"2fa2e5ec\",\"base_bitwiseoperation.md\":\"478db3c5\",\"base_linkedlist.md\":\"1e391da1\",\"compilation_beauty_code-understand.md\":\"8d9f830a\",\"compilation_beauty_intro.md\":\"3f18d02c\",\"compilation_intro.md\":\"cb135003\",\"devops_aws-ubuntu.md\":\"e2bb0b6d\",\"devops_docker.md\":\"d9ea5ec0\",\"devops_linux_file-system_1-man.md\":\"63e0a792\",\"devops_linux_file-system_11-find.md\":\"1f0ad133\",\"devops_linux_file-system_12-ag.md\":\"fde71b31\",\"devops_linux_file-system_2-dir-change.md\":\"2c62d8b1\",\"devops_linux_file-system_3-user.md\":\"2b5d6c3e\",\"devops_linux_file-system_4-stat.md\":\"a7638125\",\"devops_linux_file-system_5-chmod-chown.md\":\"8aae5c14\",\"devops_linux_file-system_6-ln.md\":\"8a7600a9\",\"devops_linux_file-system_7-cat-less-head-tail.md\":\"48db9d70\",\"devops_linux_file-system_8-pipe-redirection.md\":\"a7f875f9\",\"devops_linux_file-system_9-glob.md\":\"972cb0df\",\"devops_linux_file-system_vim-move.md\":\"99e6fa96\",\"devops_nginx.md\":\"c7c81146\",\"http_header_5-header.md\":\"df916537\",\"http_header_6-request-header.md\":\"33132900\",\"http_header_7-response-header.md\":\"cfb88b6b\",\"http_header_8-host-authority.md\":\"09185e63\",\"http_header_9-content-nego.md\":\"469c4a79\",\"http_message_1-message.md\":\"be75db95\",\"http_message_2-message-simulation.md\":\"633c8c38\",\"http_message_3-chrome-devtools.md\":\"82f7b402\",\"http_message_4-curl.md\":\"b47500cd\",\"index.md\":\"6b4ffeee\",\"node_intro.md\":\"793bddbb\",\"others_bff-log.md\":\"03751914\",\"others_cmd.md\":\"9991725b\",\"others_cors.md\":\"5eaf6e3f\",\"others_nuxt3.md\":\"3aceb047\",\"rust_basic_1.md\":\"01af269b\",\"rust_index.md\":\"1a82c422\",\"rust_pre_1.md\":\"3e2ec74e\",\"rust_pre_2.md\":\"802b1b4e\",\"rust_pre_3.md\":\"939c61fb\",\"toolchain_babel_api.md\":\"19e7e812\",\"toolchain_babel_ast.md\":\"3d9393e4\",\"toolchain_babel_babel.md\":\"f09cc4ff\",\"toolchain_babel_parser.md\":\"b8c28acc\",\"toolchain_babel_traverse.md\":\"52e68a07\",\"toolchain_engineering_build.md\":\"3c8d81fe\",\"toolchain_engineering_deploy.md\":\"09b15da2\",\"toolchain_engineering_devops.md\":\"b6f58b5a\",\"toolchain_engineering_docsite.md\":\"bcc3eb9e\",\"toolchain_engineering_engineering.md\":\"c0a026b3\",\"toolchain_engineering_management.md\":\"fba516e1\",\"toolchain_engineering_services.md\":\"10586d14\",\"toolchain_engineering_standard.md\":\"b645394d\",\"toolchain_engineering_structure.md\":\"69388c7d\",\"toolchain_index.md\":\"03946e95\",\"toolchain_rollup_tspackage.md\":\"3999364b\",\"toolchain_vite_config.md\":\"b76920a2\",\"toolchain_vite_esbuild.md\":\"e5008b55\",\"toolchain_vite_esm.md\":\"d6f2d350\",\"toolchain_vite_federation.md\":\"a9235e0b\",\"toolchain_vite_hmr.md\":\"76cca21d\",\"toolchain_vite_hmr2.md\":\"0f085dd0\",\"toolchain_vite_module.md\":\"8b675b15\",\"toolchain_vite_optimize.md\":\"f94b677a\",\"toolchain_vite_overview.md\":\"ce676a94\",\"toolchain_vite_plugin.md\":\"36c6154a\",\"toolchain_vite_pluginpipeline.md\":\"2be50a29\",\"toolchain_vite_polyfill.md\":\"a20d9677\",\"toolchain_vite_prebuild.md\":\"0f2e5904\",\"toolchain_vite_ssr.md\":\"96acd30d\",\"toolchain_vite_style.md\":\"37d520fe\",\"translate_index.md\":\"231bdc29\",\"translate_v18-release-announce.md\":\"ce124ff5\",\"typescript_challenges_two-sum.md\":\"13e7c8a2\",\"typescript_fun_basic.md\":\"8dfff38d\",\"typescript_fun_builtin.md\":\"090a4405\",\"typescript_fun_calculate.md\":\"7256f793\",\"typescript_fun_patternmatching.md\":\"c6ea1e24\",\"typescript_fun_practice.md\":\"f6cfc495\",\"typescript_fun_principle.md\":\"b9a87238\",\"typescript_fun_rebuild.md\":\"32d17bea\",\"typescript_fun_recursion.md\":\"a1739ab8\",\"typescript_fun_special.md\":\"4d2fca5a\",\"typescript_fun_union.md\":\"a8d3b759\",\"typescript_issues_cjs-in-esm.md\":\"01419d88\",\"typescript_others_distributeddts.md\":\"502eba16\"}")</script>
    <script type="module" async src="/assets/app.a067e1d4.js"></script>
    
  </body>
</html>