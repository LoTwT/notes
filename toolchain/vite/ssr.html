<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SSR | Ayingotts's notes</title>
    <meta name="description" content="useless and naive notes">
    <link rel="stylesheet" href="/assets/style.408b4477.css">
    <link rel="modulepreload" href="/assets/app.a067e1d4.js">
    <link rel="modulepreload" href="/assets/toolchain_vite_ssr.md.96acd30d.lean.js">
    
    <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-c92dac7e><!--[--><!--]--><!--[--><span tabindex="-1" data-v-db27ec01></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-db27ec01> Skip to content </a><!--]--><!----><header class="VPNav" data-v-c92dac7e data-v-f621f495><div class="VPNavBar has-sidebar" data-v-f621f495 data-v-9c650fd0><div class="container" data-v-9c650fd0><div class="VPNavBarTitle has-sidebar" data-v-9c650fd0 data-v-ebccea6a><a class="title" href="/" data-v-ebccea6a><!--[--><!--]--><!--[--><img class="VPImage logo" src="/mea.jpg" alt data-v-4a040b55><!--]--><!--[-->Ayingotts&#39;s notes<!--]--><!--[--><!--]--></a></div><div class="content" data-v-9c650fd0><!--[--><!--]--><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-9c650fd0 data-v-2bb0b325><span id="main-nav-aria-label" class="visually-hidden" data-v-2bb0b325>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/base/bitwiseOperation.html" data-v-2bb0b325 data-v-5a374801 data-v-7ba7224b><!--[-->计算机基础<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/compilation/intro.html" data-v-2bb0b325 data-v-5a374801 data-v-7ba7224b><!--[-->编译<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/algorithm/index.html" data-v-2bb0b325 data-v-5a374801 data-v-7ba7224b><!--[-->算法<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/http/message/1-message.html" data-v-2bb0b325 data-v-5a374801 data-v-7ba7224b><!--[-->HTTP<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/devops/aws-ubuntu.html" data-v-2bb0b325 data-v-5a374801 data-v-7ba7224b><!--[-->DevOps<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/typescript/fun/basic.html" data-v-2bb0b325 data-v-5a374801 data-v-7ba7224b><!--[-->TypeScript<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/toolchain/index.html" data-v-2bb0b325 data-v-5a374801 data-v-7ba7224b><!--[-->工具链<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/others/cmd.html" data-v-2bb0b325 data-v-5a374801 data-v-7ba7224b><!--[-->其他<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-9c650fd0 data-v-fe0bb805><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-fe0bb805 data-v-7cf364fc data-v-dc3b1b1e><span class="check" data-v-dc3b1b1e><span class="icon" data-v-dc3b1b1e><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-7cf364fc><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-7cf364fc><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-9c650fd0 data-v-fee08697 data-v-620d60cf><!--[--><a class="VPSocialLink" href="https://github.com/lotwt/notes" target="_blank" rel="noopener" data-v-620d60cf data-v-7dad4ed6><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-9c650fd0 data-v-9ff62427 data-v-66d5c524><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-66d5c524><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-66d5c524><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-66d5c524><div class="VPMenu" data-v-66d5c524 data-v-56fa3a4a><!----><!--[--><!--[--><!----><div class="group" data-v-9ff62427><div class="item appearance" data-v-9ff62427><p class="label" data-v-9ff62427>Appearance</p><div class="appearance-action" data-v-9ff62427><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-9ff62427 data-v-7cf364fc data-v-dc3b1b1e><span class="check" data-v-dc3b1b1e><span class="icon" data-v-dc3b1b1e><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-7cf364fc><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-7cf364fc><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-9ff62427><div class="item social-links" data-v-9ff62427><div class="VPSocialLinks social-links-list" data-v-9ff62427 data-v-620d60cf><!--[--><a class="VPSocialLink" href="https://github.com/lotwt/notes" target="_blank" rel="noopener" data-v-620d60cf data-v-7dad4ed6><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-9c650fd0 data-v-b5b99466><span class="container" data-v-b5b99466><span class="top" data-v-b5b99466></span><span class="middle" data-v-b5b99466></span><span class="bottom" data-v-b5b99466></span></span></button></div></div></div><!----></header><div class="VPLocalNav" data-v-c92dac7e data-v-cfe445aa><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-cfe445aa><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-cfe445aa><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-cfe445aa>Menu</span></button><a class="top-link" href="#" data-v-cfe445aa> Return to top </a></div><aside class="VPSidebar" data-v-c92dac7e data-v-c857a5d6><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-c857a5d6><span class="visually-hidden" id="sidebar-aria-label" data-v-c857a5d6> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-c857a5d6><section class="VPSidebarGroup" data-v-c857a5d6 data-v-87ede61d><!----><div class="items" data-v-87ede61d><!--[--><!--[--><a class="VPLink link link" href="/toolchain/index.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>目录</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><div class="group" data-v-c857a5d6><section class="VPSidebarGroup collapsible" data-v-c857a5d6 data-v-87ede61d><div class="title" role="button" data-v-87ede61d><h2 class="title-text" data-v-87ede61d>Vite</h2><div class="action" data-v-87ede61d><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-87ede61d><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-87ede61d><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-87ede61d><!--[--><!--[--><a class="VPLink link link" href="/toolchain/vite/overview.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>概览</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/module.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>模块规范</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/style.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>样式方案</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/esbuild.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>esbuild</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/plugin.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>插件</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/hmr.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>热更新</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/polyfill.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>语法降级与 polyfill</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link active" href="/toolchain/vite/ssr.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>SSR</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/federation.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>模块联邦</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/esm.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>再谈 ESM</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/optimize.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>性能优化</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/config.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>配置解析</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/prebuild.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>依赖预构建</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/pluginPipeline.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>插件流水线</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/vite/hmr2.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>毫秒级 HMR 实现揭秘</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><div class="group" data-v-c857a5d6><section class="VPSidebarGroup collapsible" data-v-c857a5d6 data-v-87ede61d><div class="title" role="button" data-v-87ede61d><h2 class="title-text" data-v-87ede61d>工程化</h2><div class="action" data-v-87ede61d><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-87ede61d><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-87ede61d><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-87ede61d><!--[--><!--[--><a class="VPLink link link" href="/toolchain/engineering/engineering.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>前端工程化</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/engineering/standard.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>规范</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/engineering/services.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>服务</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/engineering/management.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>管理</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/engineering/build.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>构建</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/engineering/structure.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>组织</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/engineering/deploy.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>部署</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/engineering/docsite.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>文档站点</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/engineering/devops.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>开发运维</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><div class="group" data-v-c857a5d6><section class="VPSidebarGroup collapsible" data-v-c857a5d6 data-v-87ede61d><div class="title" role="button" data-v-87ede61d><h2 class="title-text" data-v-87ede61d>Rollup</h2><div class="action" data-v-87ede61d><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-87ede61d><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-87ede61d><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-87ede61d><!--[--><!--[--><a class="VPLink link link" href="/toolchain/rollup/tspackage.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>构建 ts package</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><div class="group" data-v-c857a5d6><section class="VPSidebarGroup collapsible" data-v-c857a5d6 data-v-87ede61d><div class="title" role="button" data-v-87ede61d><h2 class="title-text" data-v-87ede61d>Babel</h2><div class="action" data-v-87ede61d><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-87ede61d><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-87ede61d><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-87ede61d><!--[--><!--[--><a class="VPLink link link" href="/toolchain/babel/babel.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>Babel</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/babel/AST.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>AST</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/babel/API.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>API</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/babel/parser.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>Parser</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/toolchain/babel/traverse.html" style="padding-left:0px;" data-v-4980a24a data-v-7ba7224b><!--[--><span class="link-text" data-v-4980a24a>Traverse</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-c92dac7e data-v-f75f4939><div class="VPDoc has-sidebar has-aside" data-v-f75f4939 data-v-7dd55a9c><div class="container" data-v-7dd55a9c><div class="aside" data-v-7dd55a9c><div class="aside-curtain" data-v-7dd55a9c></div><div class="aside-container" data-v-7dd55a9c><div class="aside-content" data-v-7dd55a9c><div class="VPDocAside" data-v-7dd55a9c data-v-5ba92c36><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-5ba92c36 data-v-effbad20><div class="content" data-v-effbad20><div class="outline-marker" data-v-effbad20></div><div class="outline-title" data-v-effbad20>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-effbad20><span class="visually-hidden" id="doc-outline-aria-label" data-v-effbad20> Table of Contents for current page </span><ul class="root" data-v-effbad20 data-v-d5e839a5><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-5ba92c36></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-7dd55a9c><div class="content-container" data-v-7dd55a9c><!--[--><!--]--><main class="main" data-v-7dd55a9c><div style="position:relative;" class="vp-doc _toolchain_vite_ssr" data-v-7dd55a9c><div><h1 id="ssr" tabindex="-1">SSR <a class="header-anchor" href="#ssr" aria-hidden="true">#</a></h1><p>随着 AJAX 技术的成熟以及各种前端框架的兴起，前后端分离的开发模式逐渐成为常态，前端只负责页面 UI 及逻辑的开发，而服务端只负责提供数据接口，这种开发方式下的页面渲染叫客户端渲染 ( Client Side Render ，简称 CSR ) 。</p><p>客户端渲染存在首屏加载慢，SEO 不友好等问题，因此 SSR ( Server Side Render ) 即服务端渲染技术应运而生，它保留 CSR 技术栈的同时，也能解决 CSR 的各种问题。</p><h2 id="基本概念" tabindex="-1">基本概念 <a class="header-anchor" href="#基本概念" aria-hidden="true">#</a></h2><p>CSR 的 HTML 产物结构：</p><div class="language-html"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki"><code><span class="line"><span style="color:#89DDFF;">&lt;!</span><span style="color:#F07178;">DOCTYPE</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">html</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">html</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">head</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">meta</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">charset</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">utf-8</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">title</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">title</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">link</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">rel</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">stylesheet</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">href</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xxx.css</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">head</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">body</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">&lt;!-- 一开始没有页面内容 --&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">id</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">root</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">&lt;!-- 通过 JS 执行来渲染页面 --&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">    &lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">src</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xxx.chunk.js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">body</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">html</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><p>浏览器渲染流程：</p><p><img src="/vite/browser-render.jpg" alt="浏览器渲染流程"></p><p>当浏览器拿到 CSR 的 HTML 内容后，并不能立即渲染完整的页面内容，此时 body 中只有一个空的 div 节点。需要等待浏览器下载并执行 JS 代码，经历了框架初始化、数据请求、DOM 插入等操作后才能渲染出完整的页面。</p><p>CSR 中完整的页面内容本质上通过 JS 代码执行之后进行渲染，所以会导致首屏加载慢和 SEO 不友好。</p><p>然而，在 SSR 的场景下，服务端生成好完整的 HTML 内容，直接返回给浏览器，浏览器能够根据 HTML 渲染出完整的首屏内容，而不需要依赖 JS 的加载。</p><p>但是，SSR 中只能生成页面的内容和结构，并不能完成事件绑定，因此需要在浏览器中执行 CSR 的 JS 脚本，完成事件绑定，让页面拥有交互的能力，这个过程被称作 hydrate ( 可以翻译为注水、激活、水合 ) 。</p><p>像这样服务端渲染 + 客户端 hydrate 的应用叫做同构应用。</p><h2 id="生命周期" tabindex="-1">生命周期 <a class="header-anchor" href="#生命周期" aria-hidden="true">#</a></h2><p>SSR 首先需要保证前端的代码经过编译后放到服务端中能够正常执行，其次在服务端渲染前端组件，生成并组装应用的 HTML 。</p><p>这里涉及到了 SSR 应用的两大生命周期：构建时和运行时。</p><p>SSR 是构建时和运行时互相配合才能实现，仅靠构建工具是不够的，写一个 Vite 插件严格意义上无法实现 SSR 的能力，需要对 Vite 的构建流程做一些整体的调整，并且加入一些服务端运行时的逻辑才能实现。</p><h3 id="构建时" tabindex="-1">构建时 <a class="header-anchor" href="#构建时" aria-hidden="true">#</a></h3><p>构建时需要做以下事情：</p><ol><li><p>解决模块加载问题。在原有的构建过程外，需要加入 SSR 构建过程，具体来说，就是需要另外生成一份 CommonJS 格式的产物，使之能在 Node.js 正常加载。但随着 Node.js 对 ESM 的支持越来越成熟，可以复用前端 ESM 格式的代码。</p></li><li><p>移除样式代码的引入。直接引入一行 CSS 在服务端是无法执行的，因为 Node.js 无法解析 CSS 内容，但 CSS Modules 情况除外：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> styles </span><span style="color:#89DDFF;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">./index.module.css</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// 这里的 styles 是一个对象，如{ &quot;container&quot;: &quot;xxx&quot; }，而不是 CSS 代码</span></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(styles)</span></span>
<span class="line"></span></code></pre></div></li><li><p>依赖外部化 ( external ) 。对于某些第三方依赖，并不需要使用构建后的版本，而是直接从 node_modules 中读取，比如 react-dom ，因此在 SSR 构建的过程中将不会构建这些依赖，从而加速 SSR 构建。</p></li></ol><h3 id="运行时" tabindex="-1">运行时 <a class="header-anchor" href="#运行时" aria-hidden="true">#</a></h3><p>SSR 的运行时可以拆分为比较固定的生命周期阶段：</p><ol><li>加载 SSR 入口模块。在这个阶段，需要确定 SSR 构建产物的入口，即组件的入口在哪里，并加载对应的模块。</li><li>进行数据预取。这个阶段，Node.js 侧会通过查询数据库或者网络请求来获取应用所需的数据。</li><li>渲染组件。这个阶段是 SSR 的核心，主要将第一步中加载组件渲染成 HTML 字符串或 Stream 流。</li><li>HTML 拼接。在组件渲染完成之后，需要拼接完整的 HTML 字符串，并将其作为响应返回给浏览器。</li></ol><h2 id="基于-vite-搭建-ssr-项目" tabindex="-1">基于 Vite 搭建 SSR 项目 <a class="header-anchor" href="#基于-vite-搭建-ssr-项目" aria-hidden="true">#</a></h2><h3 id="ssr-构建-api" tabindex="-1">SSR 构建 API <a class="header-anchor" href="#ssr-构建-api" aria-hidden="true">#</a></h3><p>开发环境下，Vite 秉承 ESM 模块按需加载即 no-bundle 的理念，对外提供 <code>ssrLoadModule</code> API ，无需打包项目，将入口文件的路径传入即可。</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// 加载服务端入口模块</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> xxx </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">await</span><span style="color:#A6ACCD;"> vite</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ssrLoadModule</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/src/entry-server.tsx</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span></code></pre></div><p>在生产环境下，Vite 会默认进行打包，对于 SSR 构建输出 CommonJS 格式的产物。( Vite 3 改为 ESM )</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// package.json</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">build:ssr</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">vite build --ssr 服务端入口路径</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>通过执行上述命令，Vite 会专门为 SSR 打包出一份构建产物，开箱即用即可。</p><h3 id="项目链接" tabindex="-1">项目链接 <a class="header-anchor" href="#项目链接" aria-hidden="true">#</a></h3><p><a href="https://github.com/LoTwT/vite-ssr-demo" target="_blank" rel="noreferrer">vite-ssr-demo</a></p><h3 id="工程化问题" tabindex="-1">工程化问题 <a class="header-anchor" href="#工程化问题" aria-hidden="true">#</a></h3><h4 id="路由管理" tabindex="-1">路由管理 <a class="header-anchor" href="#路由管理" aria-hidden="true">#</a></h4><p>在 SPA 场景下，对于不同的前端框架，一般会有不同的路由管理方案，如 Vue 中的 vue-router ，React 的 react-router ，但不管是什么路由方案，在 SSR 过程中所完成的功能都是差不多的：</p><ol><li>告诉框架现在渲染哪个路由。在 Vue 中使用 <code>router.push</code> ，在 React 中通过 <code>StaticRouter</code> 配合 <code>location</code> 参数。</li><li>设置 <code>base</code> 前缀。规定路径的前缀，如 <code>vue-router</code> 的 base 参数，react-router 中 <code>StaticRouter</code> 组件的 basename 。</li></ol><h4 id="全局状态管理" tabindex="-1">全局状态管理 <a class="header-anchor" href="#全局状态管理" aria-hidden="true">#</a></h4><p>对于全局的状态管理而言，不同的框架也有不同的生态和方案。</p><p>各个状态管理工具接入 SSR 的思路也比较简单，在<code>预取数据</code>阶段初始化服务端的 <code>store</code> ，将异步获取的数据存入 <code>store</code> ，然后在<code>拼接 HTML</code> 阶段将数据从 <code>store</code> 中取出，放到 <code>script</code> 标签中，最后在客户端 <code>hydrate</code> 时通过 <code>window</code> 访问到预取数据。</p><blockquote><p>需要注意的是，服务端处理很多不同的请求，对于每个请求都需要分别初始化 store ，即一个请求一个 store ，不然会造成全局状态污染。</p></blockquote><h3 id="csr-降级" tabindex="-1">CSR 降级 <a class="header-anchor" href="#csr-降级" aria-hidden="true">#</a></h3><p>在某些极端情况下，需要从 SSR 降级回 CSR ，即客户端渲染，一般包括以下场景：</p><ol><li>服务端预取数据失败，需要降级到客户端获取数据</li><li>服务器异常，需要返回兜底的 CSR 模板，完全降级为 CSR</li><li>本地开发调试，有时需要跳过 SSR ，仅进行 CSR</li></ol><h3 id="浏览器-api-兼容" tabindex="-1">浏览器 API 兼容 <a class="header-anchor" href="#浏览器-api-兼容" aria-hidden="true">#</a></h3><p>Node.js 中不能使用 window 、document 等 API 。</p><p>可以通过 <code>i<wbr>mport.meta.env.SSR</code> 这个 Vite 内置的环境变量判断是否处于 SSR 环境。</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">import</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">meta</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">env</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SSR) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 服务端执行的逻辑</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 访问浏览器 API</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>也可以通过 polyfill 的方式，在 Node.js 中注入浏览器的 API ，推荐使用 <code>jsdom</code> 。</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> jsdom </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">require</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">jsdom</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> window </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">JSDOM</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">&lt;!DOCTYPE html&gt;&lt;p&gt;Hello world&lt;/p&gt;</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> document </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> window</span></span>
<span class="line"><span style="color:#676E95;">// 挂载到 node 全局</span></span>
<span class="line"><span style="color:#A6ACCD;">global</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">window </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> window</span></span>
<span class="line"><span style="color:#A6ACCD;">global</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">document </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> document</span></span>
<span class="line"></span></code></pre></div><h3 id="自定义-head" tabindex="-1">自定义 Head <a class="header-anchor" href="#自定义-head" aria-hidden="true">#</a></h3><p>在 SSR 过程中，虽然可以决定组件的内容，如 <code>&lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</code> 这个容器 div 中的内容，但对于 HTML 中 head 的内容，无法根据组件的内部状态来决定。</p><p>React 的 react-helmet 以及 Vue 的 vue-meta 就是为了解决这样的问题，可以直接在组件中写 Head 标签，在服务端能够拿到组件内部的状态。</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// 前端组件逻辑</span></span>
<span class="line"><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">Helmet</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">react-helmet</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">App</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">props</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">data</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">props</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    &lt;div&gt;</span></span>
<span class="line"><span style="color:#F07178;">       &lt;Helmet&gt;</span></span>
<span class="line"><span style="color:#F07178;">        &lt;title&gt;{ data.</span><span style="color:#A6ACCD;">user</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">的页面</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#A6ACCD;">title</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">link</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">rel</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">canonical</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">href</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">http://mysite.com/example</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">/&gt;</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#A6ACCD;">Helmet</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#A6ACCD;">div</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#676E95;">// 服务端逻辑</span></span>
<span class="line"><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> Helmet </span><span style="color:#89DDFF;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">react-helmet</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// renderToString 执行之后</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> helmet </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Helmet</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">renderStatic</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">title 内容: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> helmet</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">title</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toString</span><span style="color:#A6ACCD;">())</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">link 内容: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> helmet</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">link</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toString</span><span style="color:#A6ACCD;">())</span></span>
<span class="line"></span></code></pre></div><h3 id="流式渲染" tabindex="-1">流式渲染 <a class="header-anchor" href="#流式渲染" aria-hidden="true">#</a></h3><p>在不同前端框架的底层都实现了流式渲染的能力，即边渲染边响应，而不是等整个组件树渲染完毕后再响应，这样做可以让响应提前到达浏览器，提升首屏的加载性能。</p><p>Vue 的 renderToNodeStream 和 React 中的 renderToNodeStream 都实现了流式渲染的能力。</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">renderToNodeStream</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">react-dom/server</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// 返回一个 Nodejs 的 Stream 对象</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> stream </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">renderToNodeStream</span><span style="color:#A6ACCD;">(element)</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> html </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">stream</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">on</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">data</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">html</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toString</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 发送响应</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">stream</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">on</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">end</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">html</span><span style="color:#F07178;">) </span><span style="color:#676E95;">// 渲染完成</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 发送响应</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">stream</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">on</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">error</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 错误处理</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span></code></pre></div><p>流式渲染在带来首屏性能提升的同时，也带来了一些限制，如果需要在 HTML 中填入一些与组件状态相关的内容，则不能使用流式渲染。</p><p>比如 react-helmet 中自定的 head 内容，即便在渲染组件的时候收集到了 head 信息，但在流式渲染中，此时 HTML 的 head 部分已经发哦是那个给浏览器了，而这部分响应内容已经无法更改，因此 react-helmet 在 SSR 过程中将会失效。</p><h3 id="ssr-缓存" tabindex="-1">SSR 缓存 <a class="header-anchor" href="#ssr-缓存" aria-hidden="true">#</a></h3><p>SSR 是一种典型的 CPU 密集型操作，为了尽可能降低线上机器的负载，设置缓存是一个非常重要的环节。</p><p>在 SSR 运行时，缓存的内容可以分为这么几个部分：</p><ol><li><p>文件读取缓存。尽可能避免重复读磁盘的操作，每次磁盘 IO 尽可能地复用缓存结果。</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">createMemoryFsRead</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fileContentMap</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">Map</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">async</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">filePath</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">cacheResult</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fileContentMap</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">filePath</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">cacheResult</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">cacheResult</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fileContent</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">await</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readFile</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">filePath</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">fileContentMap</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">set</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">filePath</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fileContent</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fileContent</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> memoryFsRead </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">createMemoryFsRead</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"><span style="color:#82AAFF;">memoryFsRead</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">file1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#676E95;">// 直接复用缓存</span></span>
<span class="line"><span style="color:#82AAFF;">memoryFsRead</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">file1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span></code></pre></div></li><li><p>预取数据缓存。对于某些实时性不高的接口数据，可以采取缓存的策略，在下次相同的请求进来时复用之前预取数据的结果，这样预取数据过程的各种 IO 小号，也可以一定程度上减少首屏时间。</p></li><li><p>HTML 渲染缓存。拼接完成的 HTML 内容是缓存的重点，如果能将这部分进行缓存，那么下次命中缓存后，将可以节省 <code>renderToString</code> 、<code>HTML 拼接</code>等一系列的消耗，服务端的性能收益会比较明显。</p></li></ol><p>对于以上的缓存内容，具体的缓存位置可以是：</p><ol><li>服务器内存。如果是放到内存中，需要考虑缓存淘汰机制，防止内存过大导致服务宕机，一个典型的缓存淘汰方案是 LRU Cache 。</li><li>Redis 。相当于以传统后端服务器的设计思路来处理缓存。</li><li>CDN 服务。可以将页面内容缓存到 CDN 服务上，在下一次相同的请求进来时，使用 CDN 上的缓存内容，而不用消费源服务器的资源。对于 CDN 上的 SSR 缓存，可以阅读<a href="https://juejin.cn/post/6887884087915184141#heading-8" target="_blank" rel="noreferrer">这篇文章</a> 。</li></ol><blockquote><p>Vue 中另外实现了<a href="https://vuejs.org/guide/scaling-up/ssr.html" target="_blank" rel="noreferrer">组件级别的缓存</a> ， 这部分一般放在内存中，可以实现更细粒度的 SSR 缓存。</p></blockquote><h3 id="性能监控" tabindex="-1">性能监控 <a class="header-anchor" href="#性能监控" aria-hidden="true">#</a></h3><p>在实际的 SSR 项目中，时长会遇到一些 SSR 线上性能问题，对于 SSR 性能数据，有一些比较通用的指标：</p><ol><li>SSR 产物加载时间</li><li>数据预取的时间</li><li>组件渲染的时间</li><li>服务端接受请求到响应的完整时间</li><li>SSR 缓存命中情况</li><li>SSR 成功率、错误日志</li></ol><p>可以通过 <code>perf_hooks</code> 完成数据采集：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki"><code><span class="line"><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">performance</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">PerformanceObserver</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">perf_hooks</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// 初始化监听器逻辑</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> perfObserver </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PerformanceObserver</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">items</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">items</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getEntries</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">forEach</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">entry</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">[performance]</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">entry</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">entry</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">duration</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toFixed</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">2</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ms</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">performance</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">clearMarks</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">perfObserver</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">observe</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">entryTypes</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> [</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">measure</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">] </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// 接下来我们在 SSR 进行打点</span></span>
<span class="line"><span style="color:#676E95;">// 以 renderToString  为例</span></span>
<span class="line"><span style="color:#A6ACCD;">performance</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">mark</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">render-start</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#676E95;">// renderToString 代码省略</span></span>
<span class="line"><span style="color:#A6ACCD;">performance</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">mark</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">render-end</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">performance</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">measure</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">renderToString</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">render-start</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">render-end</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span></code></pre></div><h3 id="ssr、isr、spr" tabindex="-1">SSR、ISR、SPR <a class="header-anchor" href="#ssr、isr、spr" aria-hidden="true">#</a></h3><p>有时候对于一些静态站点，如博客、文档等，不涉及到动态变化的数据，因此不需要用上 SSR 。</p><p>此时只需要在构建阶段产出完整的 HTML 进行部署即可，这种构建阶段生成 HTML 的做法叫 SSG ( Static Site Generation ，静态站点生成 ) 。</p><p>SSG 与 SSR 最大的区别就是产出 HTML 的时间点从 SSR 运行时变成了构建时，但核心的生命周期流程并没有发生变化：</p><ol><li>加载 SSR 入口</li><li>数据预取</li><li>组件渲染</li><li>HTML 拼接</li></ol><p>SSR 和 SSG 还衍生出了其他新功能：</p><ol><li>SPR 即 Serverless Pre Render ，把 SSR 的服务部署到 Serverless ( FaaS ) 环境中，实现服务器实例的自动扩缩容，降低服务器运维的成本</li><li>ISR 即 Incremental Site Rendering ，即增量站点渲染，将一部分的 SSG 逻辑从构建时搬到了 SSR 运行时，解决的是大量页面 SSG 构建耗时过长的问题</li></ol></div></div></main><!--[--><!--]--><footer class="VPDocFooter" data-v-7dd55a9c data-v-edc4fadc><div class="edit-info" data-v-edc4fadc><!----><div class="last-updated" data-v-edc4fadc><p class="VPLastUpdated" data-v-edc4fadc data-v-5ce65bc4>Last updated: <time datetime="2022-11-28T01:42:11.000Z" data-v-5ce65bc4></time></p></div></div><div class="prev-next" data-v-edc4fadc><div class="pager" data-v-edc4fadc><a class="pager-link prev" href="/toolchain/vite/polyfill.html" data-v-edc4fadc><span class="desc" data-v-edc4fadc>Previous page</span><span class="title" data-v-edc4fadc>语法降级与 polyfill</span></a></div><div class="has-prev pager" data-v-edc4fadc><a class="pager-link next" href="/toolchain/vite/federation.html" data-v-edc4fadc><span class="desc" data-v-edc4fadc>Next page</span><span class="title" data-v-edc4fadc>模块联邦</span></a></div></div></footer><!--[--><!--]--></div></div></div></div></div><!----><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"algorithm_1-twosum.md\":\"74db9f81\",\"algorithm_100-sametree.md\":\"55b26e90\",\"algorithm_101-symmetrictree.md\":\"7873761b\",\"algorithm_102-binarytreelevelordertraversal.md\":\"96215b16\",\"algorithm_104-maximumdepthofbinarytree.md\":\"f340fb7e\",\"algorithm_1047-removealladjacentduplicatesinstring.md\":\"70457bad\",\"algorithm_107-binarytreelevelordertravsal2.md\":\"1379a1de\",\"algorithm_108-convertsortedarraytobinarysearchtree.md\":\"7d8a5b43\",\"algorithm_109-convertsortedlisttobinarysearchtree.md\":\"03377f89\",\"algorithm_110-balancedbinarytree.md\":\"f8bb6a3a\",\"algorithm_111-minimundepthofbinarytree.md\":\"f62d46a0\",\"algorithm_112-pathsum.md\":\"673b1c3c\",\"algorithm_114-flattenbinarytreetolinkedlist.md\":\"c9962e5f\",\"algorithm_116-populatingnextrightpointersineachnode.md\":\"1708a580\",\"algorithm_117-populatingnextrightpointersineachnode2.md\":\"d63020a8\",\"algorithm_125-validpalindrome.md\":\"896176e9\",\"algorithm_131-palindromepartitioning.md\":\"e4061074\",\"algorithm_136-singlenumber.md\":\"15300d65\",\"algorithm_141-linkedlistcycle.md\":\"3dd49d2f\",\"algorithm_142-linkedlistcycle2.md\":\"99cfa9bb\",\"algorithm_144-binarytreepreordertraversal.md\":\"71232ffe\",\"algorithm_145-binarytreepostordertraversal.md\":\"1edfd517\",\"algorithm_146-lrucache.md\":\"01d10eec\",\"algorithm_15-3sum.md\":\"43ffbed5\",\"algorithm_150-evaluatereversepolishnotation.md\":\"1ace6f4c\",\"algorithm_151-reversewordsinastring.md\":\"15a5f365\",\"algorithm_153-findminimuminrotatedsortedarray.md\":\"bce51de1\",\"algorithm_160-intersectionoftwolinkedlist.md\":\"ce2eab18\",\"algorithm_167-twosum2inputissortedarray.md\":\"d03efdb0\",\"algorithm_17-lettercombinationsofaphonenumber.md\":\"eea1aaaa\",\"algorithm_19-removenthnodefromendoflist.md\":\"05de547f\",\"algorithm_199-binarytreerightsideview.md\":\"73404bcb\",\"algorithm_20-validparentheses.md\":\"6399855f\",\"algorithm_203-removelinkedlistelements.md\":\"05236e72\",\"algorithm_206-reverselinkedlist.md\":\"8b55d80d\",\"algorithm_209-minimumsizesubarraysum.md\":\"6f4f2ed0\",\"algorithm_21-mergetwosortedlist.md\":\"bbc08849\",\"algorithm_222-countcompletetreenode.md\":\"ebc546ce\",\"algorithm_225-implementstackusingqueues.md\":\"0c2ad4c4\",\"algorithm_226-invertbinarytree.md\":\"547222dc\",\"algorithm_230-kthsmallestelementinabst.md\":\"3c0a808c\",\"algorithm_231-poweroftwo.md\":\"cbf0633d\",\"algorithm_232-implementqueueusingstacks.md\":\"6538c93f\",\"algorithm_234-palindromelinkedlist.md\":\"4571c575\",\"algorithm_236-lowestcommonancestorofabinarytree.md\":\"6736cc07\",\"algorithm_257-binarytreepaths.md\":\"4ba74801\",\"algorithm_26-removeduplicatesfromsortedarray.md\":\"ab18dbad\",\"algorithm_27-removeelement.md\":\"33a350e9\",\"algorithm_283-movezeros.md\":\"a4e09c1c\",\"algorithm_300-longestincreasingsubsequence.md\":\"47674cf7\",\"algorithm_322-coinchange.md\":\"abc0c2f1\",\"algorithm_344-reversestring.md\":\"c223762a\",\"algorithm_37-sudokusolver.md\":\"5a4d86b3\",\"algorithm_39-combinationsum.md\":\"c4d3c07b\",\"algorithm_404-sumofleftleaves.md\":\"5407712c\",\"algorithm_429-narytreelevelordertraversal.md\":\"6f38b428\",\"algorithm_435-nonoverlappingintervals.md\":\"4968f67d\",\"algorithm_45-jumpgameii.md\":\"c5e14641\",\"algorithm_452-minimumnumberofarrowstoburstballoons.md\":\"4e6abf88\",\"algorithm_455-assigncookies.md\":\"e437dffa\",\"algorithm_46-permutations.md\":\"56cc1adc\",\"algorithm_47-permutations-ii.md\":\"d5c14345\",\"algorithm_509-fibonaccinumber.md\":\"337970cd\",\"algorithm_51-nqueens.md\":\"8b811cf5\",\"algorithm_515-findlargestvalueineachtreerow.md\":\"8d98faa2\",\"algorithm_543-diameterofbinarytree.md\":\"5b989849\",\"algorithm_55-jumpgame.md\":\"5d0e447f\",\"algorithm_572-subtreeofanothertree.md\":\"579e0bb2\",\"algorithm_617-mergetwobinarytrees.md\":\"9fc54e35\",\"algorithm_637-averageoflevelsinbinarytree.md\":\"dfcd5913\",\"algorithm_654-maximumbinarytree.md\":\"fad6abc6\",\"algorithm_69-sqrtx.md\":\"24e13dcf\",\"algorithm_700-searchinabinarysearchtree.md\":\"5e4e993a\",\"algorithm_701-insertintoabinarysearchtree.md\":\"bf129b4f\",\"algorithm_704-binarysearch.md\":\"ef6bbaa0\",\"algorithm_71-simplifypath.md\":\"91a87133\",\"algorithm_77-combinations.md\":\"3ea7d5e5\",\"algorithm_78-subsets.md\":\"51540ad5\",\"algorithm_79-wordsearch.md\":\"1ec7aaf4\",\"algorithm_860-lemonadechange.md\":\"641aedb0\",\"algorithm_876-middleofthelinkedlist.md\":\"aa795d3c\",\"algorithm_92-reverselinkedlist2.md\":\"4a034e4e\",\"algorithm_93-restoreipaddresses.md\":\"5d891e7e\",\"algorithm_94-binarytreeinordertraversal.md\":\"04c56d98\",\"algorithm_977-squaresofasortedarray.md\":\"3b285bfc\",\"algorithm_98-validatebinarysearchtree.md\":\"bda269f4\",\"algorithm_99-recoverbinarysearchtree.md\":\"575af6d6\",\"algorithm_bubblesort.md\":\"d1e04114\",\"algorithm_index.md\":\"adee06fc\",\"algorithm_leftpad.md\":\"0c3cb01d\",\"algorithm_quicksort.md\":\"5c3293f4\",\"algorithm_quicksortinplace.md\":\"2fa2e5ec\",\"base_bitwiseoperation.md\":\"478db3c5\",\"base_linkedlist.md\":\"1e391da1\",\"compilation_beauty_code-understand.md\":\"8d9f830a\",\"compilation_beauty_intro.md\":\"3f18d02c\",\"compilation_intro.md\":\"cb135003\",\"devops_aws-ubuntu.md\":\"e2bb0b6d\",\"devops_docker.md\":\"d9ea5ec0\",\"devops_linux_file-system_1-man.md\":\"63e0a792\",\"devops_linux_file-system_11-find.md\":\"1f0ad133\",\"devops_linux_file-system_12-ag.md\":\"fde71b31\",\"devops_linux_file-system_2-dir-change.md\":\"2c62d8b1\",\"devops_linux_file-system_3-user.md\":\"2b5d6c3e\",\"devops_linux_file-system_4-stat.md\":\"a7638125\",\"devops_linux_file-system_5-chmod-chown.md\":\"8aae5c14\",\"devops_linux_file-system_6-ln.md\":\"8a7600a9\",\"devops_linux_file-system_7-cat-less-head-tail.md\":\"48db9d70\",\"devops_linux_file-system_8-pipe-redirection.md\":\"a7f875f9\",\"devops_linux_file-system_9-glob.md\":\"972cb0df\",\"devops_linux_file-system_vim-move.md\":\"99e6fa96\",\"devops_nginx.md\":\"c7c81146\",\"http_header_5-header.md\":\"df916537\",\"http_header_6-request-header.md\":\"33132900\",\"http_header_7-response-header.md\":\"cfb88b6b\",\"http_header_8-host-authority.md\":\"09185e63\",\"http_header_9-content-nego.md\":\"469c4a79\",\"http_message_1-message.md\":\"be75db95\",\"http_message_2-message-simulation.md\":\"633c8c38\",\"http_message_3-chrome-devtools.md\":\"82f7b402\",\"http_message_4-curl.md\":\"b47500cd\",\"index.md\":\"6b4ffeee\",\"node_intro.md\":\"793bddbb\",\"others_bff-log.md\":\"03751914\",\"others_cmd.md\":\"9991725b\",\"others_cors.md\":\"5eaf6e3f\",\"others_nuxt3.md\":\"3aceb047\",\"rust_basic_1.md\":\"01af269b\",\"rust_index.md\":\"1a82c422\",\"rust_pre_1.md\":\"3e2ec74e\",\"rust_pre_2.md\":\"802b1b4e\",\"rust_pre_3.md\":\"939c61fb\",\"toolchain_babel_api.md\":\"19e7e812\",\"toolchain_babel_ast.md\":\"3d9393e4\",\"toolchain_babel_babel.md\":\"f09cc4ff\",\"toolchain_babel_parser.md\":\"b8c28acc\",\"toolchain_babel_traverse.md\":\"52e68a07\",\"toolchain_engineering_build.md\":\"3c8d81fe\",\"toolchain_engineering_deploy.md\":\"09b15da2\",\"toolchain_engineering_devops.md\":\"b6f58b5a\",\"toolchain_engineering_docsite.md\":\"bcc3eb9e\",\"toolchain_engineering_engineering.md\":\"c0a026b3\",\"toolchain_engineering_management.md\":\"fba516e1\",\"toolchain_engineering_services.md\":\"10586d14\",\"toolchain_engineering_standard.md\":\"b645394d\",\"toolchain_engineering_structure.md\":\"69388c7d\",\"toolchain_index.md\":\"03946e95\",\"toolchain_rollup_tspackage.md\":\"3999364b\",\"toolchain_vite_config.md\":\"b76920a2\",\"toolchain_vite_esbuild.md\":\"e5008b55\",\"toolchain_vite_esm.md\":\"d6f2d350\",\"toolchain_vite_federation.md\":\"a9235e0b\",\"toolchain_vite_hmr.md\":\"76cca21d\",\"toolchain_vite_hmr2.md\":\"0f085dd0\",\"toolchain_vite_module.md\":\"8b675b15\",\"toolchain_vite_optimize.md\":\"f94b677a\",\"toolchain_vite_overview.md\":\"ce676a94\",\"toolchain_vite_plugin.md\":\"36c6154a\",\"toolchain_vite_pluginpipeline.md\":\"2be50a29\",\"toolchain_vite_polyfill.md\":\"a20d9677\",\"toolchain_vite_prebuild.md\":\"0f2e5904\",\"toolchain_vite_ssr.md\":\"96acd30d\",\"toolchain_vite_style.md\":\"37d520fe\",\"translate_index.md\":\"231bdc29\",\"translate_v18-release-announce.md\":\"ce124ff5\",\"typescript_challenges_two-sum.md\":\"13e7c8a2\",\"typescript_fun_basic.md\":\"8dfff38d\",\"typescript_fun_builtin.md\":\"090a4405\",\"typescript_fun_calculate.md\":\"7256f793\",\"typescript_fun_patternmatching.md\":\"c6ea1e24\",\"typescript_fun_practice.md\":\"f6cfc495\",\"typescript_fun_principle.md\":\"b9a87238\",\"typescript_fun_rebuild.md\":\"32d17bea\",\"typescript_fun_recursion.md\":\"a1739ab8\",\"typescript_fun_special.md\":\"4d2fca5a\",\"typescript_fun_union.md\":\"a8d3b759\",\"typescript_issues_cjs-in-esm.md\":\"01419d88\",\"typescript_others_distributeddts.md\":\"502eba16\"}")</script>
    <script type="module" async src="/assets/app.a067e1d4.js"></script>
    
  </body>
</html>